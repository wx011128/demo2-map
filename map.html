<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³</title>
  <style>
    html,body,#map{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
    .panel{position:absolute;top:10px;left:10px;right:10px;display:flex;gap:8px;z-index:10}
    .card{background:rgba(255,255,255,0.95);padding:12px 16px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.15);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.2)}
    .grow{flex:1}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{padding:8px 12px;border-radius:20px;border:1px solid #ddd;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s ease;background:#fff}
    .pill.active{background:#007AFF;color:#fff;border-color:#007AFF;transform:scale(1.05)}
    .pill:hover{transform:scale(1.02)}
    #search{padding:12px 16px;border:1px solid #ddd;border-radius:22px;font-size:16px;outline:none;flex:1;min-width:200px;height:44px;box-sizing:border-box}
    #search:focus{border-color:#007AFF;box-shadow:0 0 0 3px rgba(0,122,255,0.1)}
    #go{padding:12px 20px;background:#007AFF;color:#fff;border:none;border-radius:22px;cursor:pointer;font-weight:600;transition:all 0.2s ease;height:44px;box-sizing:border-box;white-space:nowrap}
    #go:hover{background:#0056CC;transform:scale(1.05)}
    #go:disabled{background:#ccc;cursor:not-allowed;transform:none}
    #dist{margin-left:8px;color:#111;font-weight:600;font-size:14px;white-space:nowrap}
    /* è¿›åº¦æ¡æ ·å¼ */
    .progress-container {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 100;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #E5E5EA;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #007AFF, #34C759);
      border-radius: 4px;
      transition: width 0.5s ease;
      width: 0%;
    }
    
    .progress-text {
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    
    /* å…¨å±å¯¼èˆªç•Œé¢æ ·å¼ */
    .navigation-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }
    
    /* é¡¶éƒ¨çŠ¶æ€æ  */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 14px;
      font-weight: 600;
    }
    
    .status-icons {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    /* å¯¼èˆªæŒ‡ä»¤æ¨ªå¹… */
    .instruction-banner {
      background: #4CAF50;
      color: white;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .direction-icon {
      font-size: 24px;
      font-weight: bold;
    }
    
    .instruction-text {
      flex: 1;
    }
    
    .current-street {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .next-action {
      font-size: 14px;
      opacity: 0.9;
    }
    
    /* åœ°å›¾å®¹å™¨ */
    .map-container {
      flex: 1;
      position: relative;
      background: #f0f0f0;
    }
    
    #navMap {
      width: 100%;
      height: 100%;
    }
    
    /* å³ä¾§è¿›åº¦æ¡ */
    .progress-sidebar {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    
    .progress-circle-container {
      position: relative;
    }
    
    .progress-circle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: conic-gradient(#007AFF 0deg, #E5E5EA 0deg);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .progress-circle::before {
      content: '';
      position: absolute;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: white;
    }
    
    .progress-circle .progress-text {
      position: relative;
      z-index: 1;
      font-size: 12px;
      font-weight: 600;
      color: #333;
    }
    
    .progress-label {
      font-size: 12px;
      color: white;
      background: rgba(0, 0, 0, 0.6);
      padding: 4px 8px;
      border-radius: 12px;
    }
    
    /* åº•éƒ¨ä¿¡æ¯é¢æ¿ */
    .bottom-panel {
      background: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid #E5E5EA;
    }
    
    .time-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .remaining-time {
      font-size: 24px;
      font-weight: 600;
      color: #333;
    }
    
    .walking-icon {
      font-size: 20px;
    }
    
    .distance-info {
      font-size: 14px;
      color: #666;
    }
    
    /* é€€å‡ºæŒ‰é’® */
    .exit-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: #FF3B30;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      z-index: 1001;
    }
  </style>
  <!-- åŠ è½½ Google Maps JS + Places åº“ -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAhspEDXoZ63pYFyYaR2IpmwEDApsxsbU4&libraries=places&language=ja&region=JP&callback=init">
  </script>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <div class="card grow">
      <div class="row">
        <input id="search" placeholder="ç›®çš„åœ°ã‚’å…¥åŠ›ï¼ˆæ—¥ãƒ»ä¸­ãƒ»è‹±å¯¾å¿œï¼‰" />
        <button id="go">é–‹å§‹</button>
        <span id="dist"></span>
      </div>
    </div>
  </div>

  <!-- è¿›åº¦æ¡ -->
  <div class="progress-container" id="progressContainer" style="display: none;">
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <div class="progress-text" id="progressText">0%</div>
  </div>

  <!-- å…¨å±å¯¼èˆªç•Œé¢ -->
  <div class="navigation-screen" id="navigationScreen" style="display: none;">
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="status-bar">
      <div class="time" id="currentTime">10:56</div>
      <div class="status-icons">
        <div class="signal-icon">ğŸ“¶</div>
        <div class="wifi-icon">ğŸ“¶</div>
        <div class="battery">48%</div>
      </div>
    </div>
    
    <!-- å¯¼èˆªæŒ‡ä»¤æ¨ªå¹… -->
    <div class="instruction-banner">
      <div class="direction-icon">â†‘</div>
      <div class="instruction-text">
        <div class="current-street" id="currentStreet">å¸‚å ´ç­‹</div>
        <div class="next-action" id="nextAction">è”µå‰é€šã«å‘ã‹ã†</div>
      </div>
    </div>
    
    <!-- åœ°å›¾åŒºåŸŸ -->
    <div class="map-container">
      <div id="navMap"></div>
    </div>
    
    <!-- å³ä¾§è¿›åº¦æ¡ -->
    <div class="progress-sidebar">
      <div class="progress-circle-container">
        <div class="progress-circle" id="progressCircle">
          <div class="progress-text" id="progressText">0%</div>
        </div>
      </div>
      <div class="progress-label">é€²æ—</div>
    </div>
    
    <!-- åº•éƒ¨ä¿¡æ¯é¢æ¿ -->
    <div class="bottom-panel">
      <div class="time-info">
        <div class="remaining-time" id="remainingTime">6åˆ†</div>
        <div class="walking-icon">ğŸš¶</div>
      </div>
      <div class="distance-info" id="distanceInfo">450mãƒ»11:02</div>
    </div>
    
    <!-- é€€å‡ºæŒ‰é’® -->
    <button class="exit-btn" id="exitNav">é€€å‡º</button>
  </div>



<script>
  let map, directionsService, directionsRenderer, autocomplete;
  let navMap = null;      // å¯¼èˆªç•Œé¢çš„åœ°å›¾
  let origin = null;      // [lng, lat]
  let dest = null;        // [lng, lat]
  let travelMode = 'WALKING';
  let currentRoute = null;
  let progressInterval = null;
  let guideInterval = null;
  let currentStepIndex = 0;

  // ä» URL è·å–èµ·ç‚¹ï¼ˆç”±å°ç¨‹åºæ‹¼æ¥ï¼‰ï¼Œç¼ºçœäº¬éƒ½ç«™
  function getQueryFloat(name, def){ 
    const v = new URLSearchParams(location.search).get(name); 
    return v ? parseFloat(v) : def; 
  }


  function init(){
    const olng = getQueryFloat('olng', 135.759644); // äº¬éƒ½ç«™
    const olat = getQueryFloat('olat', 35.003118);
    origin = {lng: olng, lat: olat};

    map = new google.maps.Map(document.getElementById('map'), {
      center: origin, 
      zoom: 15, 
      disableDefaultUI: false,
      styles: [
        {
          featureType: "poi",
          elementType: "labels",
          stylers: [{ visibility: "off" }]
        }
      ]
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ 
      map,
      suppressMarkers: false,
      polylineOptions: {
        strokeColor: '#007AFF',
        strokeWeight: 4,
        strokeOpacity: 0.8
      }
    });

    // èµ·ç‚¹æ ‡è®° - æ›´æ˜æ˜¾çš„å½“å‰ä½ç½®
    new google.maps.Marker({ 
      position: origin, 
      map, 
      label: {
        text: 'ç¾åœ¨åœ°',
        color: '#fff',
        fontSize: '12px',
        fontWeight: 'bold'
      },
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 12,
        fillColor: '#007AFF',
        fillOpacity: 1,
        strokeColor: '#fff',
        strokeWeight: 3
      },
      title: 'ç¾åœ¨åœ°'
    });

    // è‡ªåŠ¨è¡¥å…¨
    const input = document.getElementById('search');
    autocomplete = new google.maps.places.Autocomplete(input, {
      fields: ['geometry','name','formatted_address'],
      types: ['establishment', 'geocode']
    });
    
    autocomplete.addListener('place_changed', () => {
      const place = autocomplete.getPlace();
      if (!place.geometry || !place.geometry.location) return;
      
      const ll = place.geometry.location;
      dest = { lng: ll.lng(), lat: ll.lat() };
      
      // æ¸…é™¤ä¹‹å‰çš„ç»ˆç‚¹æ ‡è®°
      const markers = map.markers || [];
      markers.forEach(marker => {
        if (marker.label === 'G') marker.setMap(null);
      });
      
      // æ·»åŠ æ–°çš„ç»ˆç‚¹æ ‡è®°
      const destMarker = new google.maps.Marker({ 
        position: dest, 
        map, 
        label: 'G',
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 8,
          fillColor: '#FF3B30',
          fillOpacity: 1,
          strokeColor: '#fff',
          strokeWeight: 2
        }
      });
      
      if (!map.markers) map.markers = [];
      map.markers.push(destMarker);
      
      map.panTo(dest);
    });


    // å¼€å§‹å¯¼èˆªï¼ˆè®¡ç®—è·¯çº¿ï¼‰
    document.getElementById('go').onclick = routeAndReport;
    
    // é€€å‡ºå¯¼èˆª
    document.getElementById('exitNav').onclick = exitNavigation;

    // å°ç¨‹åº -> H5 çš„ä½ç½®æ›´æ–°ï¼šæ¥æ”¶ postMessage
    window.addEventListener('message', e => {
      const { type, payload } = e.data || {};
      if (type === 'setOrigin' && payload) {
        origin = { lng: payload.lng, lat: payload.lat };
        map.setCenter(origin);
        
        // æ›´æ–°èµ·ç‚¹æ ‡è®°
        const markers = map.markers || [];
        markers.forEach(marker => {
          if (marker.label === 'S') marker.setMap(null);
        });
        
        new google.maps.Marker({ 
          position: origin, 
          map, 
          label: 'S',
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: '#007AFF',
            fillOpacity: 1,
            strokeColor: '#fff',
            strokeWeight: 2
          }
        });
      }
      if (type === 'setDest' && payload) {
        dest = { lng: payload.lng, lat: payload.lat };
        
        // æ›´æ–°ç»ˆç‚¹æ ‡è®°
        const markers = map.markers || [];
        markers.forEach(marker => {
          if (marker.label === 'G') marker.setMap(null);
        });
        
        new google.maps.Marker({ 
          position: dest, 
          map, 
          label: 'G',
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: '#FF3B30',
            fillOpacity: 1,
            strokeColor: '#fff',
            strokeWeight: 2
          }
        });
        
        routeAndReport();
      }
    });
  }

  async function routeAndReport(){
    if (!origin || !dest) {
      return alert('å‡ºç™ºåœ°/ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„');
    }
    
    document.getElementById('go').disabled = true;
    
    directionsService.route({
      origin, 
      destination: dest, 
      travelMode: 'WALKING',
      avoidHighways: true,
      avoidTolls: true
    }, (res, status) => {
      document.getElementById('go').disabled = false;
      
      if (status !== 'OK') {
        return alert('ãƒ«ãƒ¼ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + status);
      }
      
      directionsRenderer.setDirections(res);
      const leg = res.routes[0].legs[0];
      const meters = leg.distance.value;       // ç±³
      const seconds = leg.duration.value;      // ç§’
      
      document.getElementById('dist').textContent =
        `è·é›¢ ${meters < 1000 ? Math.round(meters) + 'm' : (meters/1000).toFixed(2) + 'km'}ãƒ»ç´„ ${Math.round(seconds/60)} åˆ†`;

      // ä¿å­˜è·¯çº¿å¹¶è¿›å…¥å¯¼èˆªç•Œé¢
      currentRoute = res.routes[0];
      currentStepIndex = 0;
      enterNavigationMode();

      // å›ä¼ å°ç¨‹åº
      if (window.parent && window.parent.postMessage) {
        window.parent.postMessage({
          type: 'routeUpdate',
          payload: {
            distanceMeters: meters,
            durationSeconds: seconds,
            mode: 'WALKING',
            origin: origin,
            destination: dest,
            route: res.routes[0]
          }
        }, '*');
      }
    });
  }

  // å¼€å§‹è¿›åº¦è·Ÿè¸ª
  function startProgressTracking() {
    if (!currentRoute) return;
    
    // æ˜¾ç¤ºè¿›åº¦æ¡
    document.getElementById('progressContainer').style.display = 'block';
    
    // è·å–æ€»è·ç¦»
    const totalDistance = currentRoute.legs[0].distance.value; // ç±³
    let currentDistance = 0; // å½“å‰å·²èµ°è·ç¦»
    
    // åŸºäºå®é™…ä½ç½®æ›´æ–°è¿›åº¦
    progressInterval = setInterval(() => {
      // è¿™é‡Œåº”è¯¥è·å–ç”¨æˆ·å½“å‰ä½ç½®ï¼Œç°åœ¨ç”¨æ¨¡æ‹Ÿæ•°æ®
      // å®é™…åº”ç”¨ä¸­åº”è¯¥è°ƒç”¨ wx.getLocation() è·å–çœŸå®ä½ç½®
      const simulatedProgress = Math.min(currentDistance / totalDistance * 100, 100);
      
      updateProgress(simulatedProgress);
      
      if (simulatedProgress >= 100) {
        clearInterval(progressInterval);
        setTimeout(() => {
          document.getElementById('progressContainer').style.display = 'none';
        }, 2000);
      }
    }, 2000);
  }
  
  // æ›´æ–°è¿›åº¦æ¡
  function updateProgress(percentage) {
    const progressCircle = document.getElementById('progressCircle');
    const progressText = document.getElementById('progressText');
    
    // æ›´æ–°åœ†å½¢è¿›åº¦æ¡
    const angle = (percentage / 100) * 360;
    progressCircle.style.background = `conic-gradient(#007AFF ${angle}deg, #E5E5EA ${angle}deg)`;
    progressText.textContent = Math.round(percentage) + '%';
  }
  
  // åœæ­¢è¿›åº¦è·Ÿè¸ª
  function stopProgressTracking() {
    if (progressInterval) {
      clearInterval(progressInterval);
      progressInterval = null;
    }
    document.getElementById('progressContainer').style.display = 'none';
  }
  
  // è¿›å…¥å¯¼èˆªæ¨¡å¼
  function enterNavigationMode() {
    if (!currentRoute) return;
    
    // éšè—ä¸»ç•Œé¢ï¼Œæ˜¾ç¤ºå¯¼èˆªç•Œé¢
    document.getElementById('map').style.display = 'none';
    document.getElementById('navigationScreen').style.display = 'flex';
    
    // åˆå§‹åŒ–å¯¼èˆªåœ°å›¾
    initNavigationMap();
    
    // æ›´æ–°å¯¼èˆªä¿¡æ¯
    updateNavigationInfo();
    
    // å¼€å§‹è¿›åº¦è·Ÿè¸ª
    startProgressTracking();
    
    // å®šæœŸæ›´æ–°å¯¼èˆªä¿¡æ¯
    guideInterval = setInterval(() => {
      updateNavigationInfo();
    }, 3000);
  }
  
  // é€€å‡ºå¯¼èˆªæ¨¡å¼
  function exitNavigation() {
    // æ˜¾ç¤ºä¸»ç•Œé¢ï¼Œéšè—å¯¼èˆªç•Œé¢
    document.getElementById('map').style.display = 'block';
    document.getElementById('navigationScreen').style.display = 'none';
    
    // åœæ­¢æ‰€æœ‰å®šæ—¶å™¨
    if (guideInterval) {
      clearInterval(guideInterval);
      guideInterval = null;
    }
    stopProgressTracking();
  }
  
  // åˆå§‹åŒ–å¯¼èˆªåœ°å›¾
  function initNavigationMap() {
    if (navMap) return; // å·²ç»åˆå§‹åŒ–è¿‡äº†
    
    navMap = new google.maps.Map(document.getElementById('navMap'), {
      center: origin,
      zoom: 16,
      disableDefaultUI: true,
      styles: [
        {
          featureType: "poi",
          elementType: "labels",
          stylers: [{ visibility: "off" }]
        }
      ]
    });
    
    // æ·»åŠ è·¯çº¿åˆ°å¯¼èˆªåœ°å›¾
    const navDirectionsRenderer = new google.maps.DirectionsRenderer({
      map: navMap,
      suppressMarkers: false,
      polylineOptions: {
        strokeColor: '#007AFF',
        strokeWeight: 4,
        strokeOpacity: 0.8
      }
    });
    
    navDirectionsRenderer.setDirections({
      routes: [currentRoute]
    });
  }
  
  // æ›´æ–°å¯¼èˆªä¿¡æ¯
  function updateNavigationInfo() {
    if (!currentRoute) return;
    
    const steps = currentRoute.legs[0].steps;
    const totalSteps = steps.length;
    
    if (currentStepIndex >= totalSteps) {
      document.getElementById('currentStreet').textContent = 'ç›®çš„åœ°åˆ°ç€';
      document.getElementById('nextAction').textContent = 'ãŠç–²ã‚Œæ§˜ã§ã—ãŸ';
      return;
    }
    
    const currentStep = steps[currentStepIndex];
    const instruction = currentStep.instructions.replace(/<[^>]*>/g, ''); // ç§»é™¤HTMLæ ‡ç­¾
    const distance = currentStep.distance ? currentStep.distance.text : '';
    
    // è§£ææŒ‡ä»¤ï¼Œæå–è¡—é“åå’ŒåŠ¨ä½œ
    const streetMatch = instruction.match(/(.+?)(?:ã«|ã§|ã‚’)/);
    const actionMatch = instruction.match(/(?:ã«|ã§|ã‚’)(.+)/);
    
    document.getElementById('currentStreet').textContent = streetMatch ? streetMatch[1] : 'ç¾åœ¨åœ°';
    document.getElementById('nextAction').textContent = actionMatch ? actionMatch[1] : instruction;
    
    // æ›´æ–°åº•éƒ¨ä¿¡æ¯
    const leg = currentRoute.legs[0];
    const remainingDistance = leg.distance ? leg.distance.text : '0m';
    const remainingTime = leg.duration ? leg.duration.text : '0åˆ†';
    
    document.getElementById('remainingTime').textContent = remainingTime;
    document.getElementById('distanceInfo').textContent = `${remainingDistance}ãƒ»${getArrivalTime()}`;
    
    // æ¨¡æ‹Ÿå‰è¿›åˆ°ä¸‹ä¸€æ­¥ï¼ˆå®é™…åº”ç”¨ä¸­åº”è¯¥åŸºäºä½ç½®å˜åŒ–ï¼‰
    if (Math.random() > 0.7) { // 30% æ¦‚ç‡è¿›å…¥ä¸‹ä¸€æ­¥
      currentStepIndex++;
    }
  }
  
  // è·å–åˆ°è¾¾æ—¶é—´
  function getArrivalTime() {
    const now = new Date();
    const arrival = new Date(now.getTime() + 6 * 60 * 1000); // æ¨¡æ‹Ÿ6åˆ†é’Ÿååˆ°è¾¾
    return arrival.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
  }

  // å…¨å±€å›è°ƒï¼ˆç”± script çš„ callback=init è§¦å‘ï¼‰
  window.init = init;
</script>
</body>
</html>
