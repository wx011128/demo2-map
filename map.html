<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>ナビゲーション</title>
  <style>
    html,body,#map{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
    .panel{position:absolute;top:10px;left:10px;right:10px;display:flex;gap:8px;z-index:10}
    .card{background:rgba(255,255,255,0.95);padding:12px 16px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.15);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.2)}
    .grow{flex:1}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{padding:8px 12px;border-radius:20px;border:1px solid #ddd;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s ease;background:#fff}
    .pill.active{background:#007AFF;color:#fff;border-color:#007AFF;transform:scale(1.05)}
    .pill:hover{transform:scale(1.02)}
    #search{padding:8px 12px;border:1px solid #ddd;border-radius:20px;font-size:16px;outline:none;flex:1;min-width:200px}
    #search:focus{border-color:#007AFF;box-shadow:0 0 0 3px rgba(0,122,255,0.1)}
    #go{padding:8px 16px;background:#007AFF;color:#fff;border:none;border-radius:20px;cursor:pointer;font-weight:600;transition:all 0.2s ease}
    #go:hover{background:#0056CC;transform:scale(1.05)}
    #go:disabled{background:#ccc;cursor:not-allowed;transform:none}
    #dist{margin-left:8px;color:#111;font-weight:600;font-size:14px;white-space:nowrap}
    .status{position:absolute;bottom:20px;left:20px;right:20px;background:rgba(0,0,0,0.8);color:#fff;padding:12px 16px;border-radius:12px;font-size:14px;text-align:center;z-index:10}
    .loading{display:none;color:#007AFF}
    .error{display:none;color:#FF3B30}
    .success{display:none;color:#34C759}
    
    /* 导航面板样式 */
    .navigation-panel {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 1000;
    }
    
    .nav-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .nav-header h3 {
      margin: 0;
      color: #333;
      font-size: 18px;
    }
    
    .stop-btn {
      background: #FF3B30;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 15px;
      font-size: 14px;
      cursor: pointer;
    }
    
    .current-step {
      margin-bottom: 15px;
    }
    
    .step-instruction {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
      line-height: 1.4;
    }
    
    .step-distance {
      font-size: 14px;
      color: #666;
    }
    
    .nav-progress {
      margin-bottom: 15px;
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #E5E5EA;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .progress-fill {
      height: 100%;
      background: #007AFF;
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    
    .progress-text {
      text-align: center;
      font-size: 12px;
      color: #666;
    }
    
    .nav-controls {
      display: flex;
      gap: 10px;
    }
    
    .nav-btn {
      flex: 1;
      background: #F2F2F7;
      border: 1px solid #D1D1D6;
      padding: 10px;
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .nav-btn:hover {
      background: #E5E5EA;
    }
    
    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
  <!-- 加载 Google Maps JS + Places 库 -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAhspEDXoZ63pYFyYaR2IpmwEDApsxsbU4&libraries=places&language=ja&region=JP&callback=init">
  </script>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <div class="card grow">
      <div class="row">
        <input id="search" placeholder="目的地を入力（日・中・英対応）" />
        <button id="go">ナビ開始</button>
        <span id="dist"></span>
      </div>
    </div>
  </div>

  <div class="status">
    <div class="loading" id="loading">ルート計算中...</div>
    <div class="error" id="error">ルート取得に失敗しました</div>
    <div class="success" id="success">ルートが設定されました</div>
  </div>

  <!-- 导航指引面板 -->
  <div class="navigation-panel" id="navigationPanel" style="display: none;">
    <div class="nav-header">
      <h3>ナビゲーション</h3>
      <button id="stopNav" class="stop-btn">停止</button>
    </div>
    <div class="nav-content">
      <div class="current-step" id="currentStep">
        <div class="step-instruction" id="stepInstruction">ナビゲーションを開始してください</div>
        <div class="step-distance" id="stepDistance"></div>
      </div>
      <div class="nav-progress">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">0 / 0 ステップ</div>
      </div>
      <div class="nav-controls">
        <button id="prevStep" class="nav-btn">← 前</button>
        <button id="nextStep" class="nav-btn">次 →</button>
      </div>
    </div>
  </div>

<script>
  let map, directionsService, directionsRenderer, autocomplete;
  let origin = null;      // [lng, lat]
  let dest = null;        // [lng, lat]
  let travelMode = 'WALKING';
  let currentRoute = null;
  let currentStepIndex = 0;
  let navigationActive = false;

  // 从 URL 获取起点（由小程序拼接），缺省京都站
  function getQueryFloat(name, def){ 
    const v = new URLSearchParams(location.search).get(name); 
    return v ? parseFloat(v) : def; 
  }

  function showStatus(type) {
    document.querySelectorAll('.status > div').forEach(el => el.style.display = 'none');
    document.getElementById(type).style.display = 'block';
    if (type !== 'loading') {
      setTimeout(() => {
        document.getElementById(type).style.display = 'none';
      }, 3000);
    }
  }

  function init(){
    const olng = getQueryFloat('olng', 135.759644); // 京都站
    const olat = getQueryFloat('olat', 35.003118);
    origin = {lng: olng, lat: olat};

    map = new google.maps.Map(document.getElementById('map'), {
      center: origin, 
      zoom: 15, 
      disableDefaultUI: false,
      styles: [
        {
          featureType: "poi",
          elementType: "labels",
          stylers: [{ visibility: "off" }]
        }
      ]
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ 
      map,
      suppressMarkers: false,
      polylineOptions: {
        strokeColor: '#007AFF',
        strokeWeight: 4,
        strokeOpacity: 0.8
      }
    });

    // 起点标记 - 更明显的当前位置
    new google.maps.Marker({ 
      position: origin, 
      map, 
      label: {
        text: '現在地',
        color: '#fff',
        fontSize: '12px',
        fontWeight: 'bold'
      },
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 12,
        fillColor: '#007AFF',
        fillOpacity: 1,
        strokeColor: '#fff',
        strokeWeight: 3
      },
      title: '現在地'
    });

    // 自动补全
    const input = document.getElementById('search');
    autocomplete = new google.maps.places.Autocomplete(input, {
      fields: ['geometry','name','formatted_address'],
      types: ['establishment', 'geocode']
    });
    
    autocomplete.addListener('place_changed', () => {
      const place = autocomplete.getPlace();
      if (!place.geometry || !place.geometry.location) return;
      
      const ll = place.geometry.location;
      dest = { lng: ll.lng(), lat: ll.lat() };
      
      // 清除之前的终点标记
      const markers = map.markers || [];
      markers.forEach(marker => {
        if (marker.label === 'G') marker.setMap(null);
      });
      
      // 添加新的终点标记
      const destMarker = new google.maps.Marker({ 
        position: dest, 
        map, 
        label: 'G',
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 8,
          fillColor: '#FF3B30',
          fillOpacity: 1,
          strokeColor: '#fff',
          strokeWeight: 2
        }
      });
      
      if (!map.markers) map.markers = [];
      map.markers.push(destMarker);
      
      map.panTo(dest);
      showStatus('success');
    });

    // 导航控制按钮
    document.getElementById('stopNav').onclick = stopNavigation;
    document.getElementById('prevStep').onclick = () => changeStep(-1);
    document.getElementById('nextStep').onclick = () => changeStep(1);

    // 开始导航（计算路线）
    document.getElementById('go').onclick = routeAndReport;

    // 小程序 -> H5 的位置更新：接收 postMessage
    window.addEventListener('message', e => {
      const { type, payload } = e.data || {};
      if (type === 'setOrigin' && payload) {
        origin = { lng: payload.lng, lat: payload.lat };
        map.setCenter(origin);
        
        // 更新起点标记
        const markers = map.markers || [];
        markers.forEach(marker => {
          if (marker.label === 'S') marker.setMap(null);
        });
        
        new google.maps.Marker({ 
          position: origin, 
          map, 
          label: 'S',
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: '#007AFF',
            fillOpacity: 1,
            strokeColor: '#fff',
            strokeWeight: 2
          }
        });
      }
      if (type === 'setDest' && payload) {
        dest = { lng: payload.lng, lat: payload.lat };
        
        // 更新终点标记
        const markers = map.markers || [];
        markers.forEach(marker => {
          if (marker.label === 'G') marker.setMap(null);
        });
        
        new google.maps.Marker({ 
          position: dest, 
          map, 
          label: 'G',
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: '#FF3B30',
            fillOpacity: 1,
            strokeColor: '#fff',
            strokeWeight: 2
          }
        });
        
        routeAndReport();
      }
    });
  }

  async function routeAndReport(){
    if (!origin || !dest) {
      showStatus('error');
      return alert('出発地/目的地を設定してください');
    }
    
    showStatus('loading');
    document.getElementById('go').disabled = true;
    
    directionsService.route({
      origin, 
      destination: dest, 
      travelMode: 'WALKING',
      avoidHighways: true,
      avoidTolls: true
    }, (res, status) => {
      document.getElementById('go').disabled = false;
      
      if (status !== 'OK') {
        showStatus('error');
        return alert('ルート取得に失敗しました: ' + status);
      }
      
      directionsRenderer.setDirections(res);
      const leg = res.routes[0].legs[0];
      const meters = leg.distance.value;       // 米
      const seconds = leg.duration.value;      // 秒
      
      document.getElementById('dist').textContent =
        `距離 ${meters < 1000 ? Math.round(meters) + 'm' : (meters/1000).toFixed(2) + 'km'}・約 ${Math.round(seconds/60)} 分`;

      showStatus('success');
      
      // 保存路线并开始导航
      currentRoute = res.routes[0];
      currentStepIndex = 0;
      startNavigation();

      // 回传小程序
      if (window.parent && window.parent.postMessage) {
        window.parent.postMessage({
          type: 'routeUpdate',
          payload: {
            distanceMeters: meters,
            durationSeconds: seconds,
            mode: 'WALKING',
            origin: origin,
            destination: dest,
            route: res.routes[0]
          }
        }, '*');
      }
    });
  }
  
  // 开始导航
  function startNavigation() {
    if (!currentRoute) return;
    
    navigationActive = true;
    document.getElementById('navigationPanel').style.display = 'block';
    updateNavigationDisplay();
  }
  
  // 停止导航
  function stopNavigation() {
    navigationActive = false;
    document.getElementById('navigationPanel').style.display = 'none';
    currentRoute = null;
    currentStepIndex = 0;
  }
  
  // 更新导航显示
  function updateNavigationDisplay() {
    if (!currentRoute || !navigationActive) return;
    
    const steps = currentRoute.legs[0].steps;
    const totalSteps = steps.length;
    
    if (currentStepIndex >= totalSteps) {
      document.getElementById('stepInstruction').textContent = '目的地に到着しました！';
      document.getElementById('stepDistance').textContent = '';
      document.getElementById('progressFill').style.width = '100%';
      document.getElementById('progressText').textContent = `${totalSteps} / ${totalSteps} ステップ`;
      return;
    }
    
    const currentStep = steps[currentStepIndex];
    const instruction = currentStep.instructions.replace(/<[^>]*>/g, ''); // 移除HTML标签
    const distance = currentStep.distance ? currentStep.distance.text : '';
    
    document.getElementById('stepInstruction').textContent = instruction;
    document.getElementById('stepDistance').textContent = distance;
    
    const progress = ((currentStepIndex + 1) / totalSteps) * 100;
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('progressText').textContent = `${currentStepIndex + 1} / ${totalSteps} ステップ`;
    
    // 更新按钮状态
    document.getElementById('prevStep').disabled = currentStepIndex === 0;
    document.getElementById('nextStep').disabled = currentStepIndex >= totalSteps - 1;
  }
  
  // 切换步骤
  function changeStep(direction) {
    if (!currentRoute || !navigationActive) return;
    
    const totalSteps = currentRoute.legs[0].steps.length;
    const newIndex = currentStepIndex + direction;
    
    if (newIndex >= 0 && newIndex < totalSteps) {
      currentStepIndex = newIndex;
      updateNavigationDisplay();
    }
  }

  // 全局回调（由 script 的 callback=init 触发）
  window.init = init;
</script>
</body>
</html>
