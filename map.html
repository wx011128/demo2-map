<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³</title>
  <style>
    html,body,#map{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;overflow:hidden}
    
    /* æœç´¢æ  */
    .search-bar {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      z-index: 1000;
    }
    
    .search-input-container {
      display: flex;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    #search {
      flex: 1;
      padding: 12px 16px;
      border: none;
      outline: none;
      font-size: 16px;
      background: transparent;
    }
    
    .search-btn {
      padding: 12px 16px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 18px;
    }
    
    /* å¯¼èˆªæŒ‡ä»¤æ¨ªå¹… */
    .navigation-banner {
      position: absolute;
      top: 80px;
      left: 20px;
      right: 20px;
      background: #4CAF50;
      color: white;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .nav-arrow {
      font-size: 24px;
      font-weight: bold;
      min-width: 30px;
      text-align: center;
    }
    
    .nav-instruction {
      flex: 1;
    }
    
    .nav-street {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .nav-direction {
      font-size: 14px;
      opacity: 0.9;
    }
    
    /* åœ°å›¾æ§åˆ¶æŒ‰é’® */
    .map-controls {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 1000;
    }
    
    .control-btn {
      width: 48px;
      height: 48px;
      border: none;
      border-radius: 24px;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .control-btn:hover {
      background: #f5f5f5;
      transform: scale(1.05);
    }
    
    .control-btn.active {
      background: #007AFF;
      color: white;
    }
    
    /* åº•éƒ¨å¯¼èˆªæ  */
    .bottom-nav {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 16px 20px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .nav-info {
      flex: 1;
    }
    
    .nav-time {
      font-size: 24px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }
    
    .nav-distance {
      font-size: 14px;
      color: #666;
    }
    
    .nav-controls {
      display: flex;
      gap: 12px;
    }
    
    .nav-control-btn {
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 20px;
      background: white;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    .nav-control-btn:hover {
      background: #f5f5f5;
    }
    
    .exit-btn {
      background: #FF3B30;
      color: white;
      border-color: #FF3B30;
    }
    
    .exit-btn:hover {
      background: #d32f2f;
    }
    
    /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
    .status-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 12px 24px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 1000;
      display: none;
    }
    
    .status-indicator.show {
      display: block;
    }
  </style>
  <!-- åŠ è½½ Google Maps JS + Places åº“ -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAhspEDXoZ63pYFyYaR2IpmwEDApsxsbU4&libraries=places&language=ja&region=JP&callback=init">
  </script>
</head>
<body>
  <div id="map"></div>

  <!-- æœç´¢æ  -->
  <div class="search-bar" id="searchBar">
    <div class="search-input-container">
      <input id="search" placeholder="ç›®çš„åœ°ã‚’å…¥åŠ›" />
      <button id="searchBtn" class="search-btn">ğŸ”</button>
    </div>
  </div>

  <!-- å¯¼èˆªæŒ‡ä»¤æ¨ªå¹… -->
  <div class="navigation-banner" id="navigationBanner" style="display: none;">
    <div class="nav-arrow" id="navArrow">â†‘</div>
    <div class="nav-instruction">
      <div class="nav-street" id="navStreet">ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„</div>
      <div class="nav-direction" id="navDirection"></div>
    </div>
  </div>

  <!-- åœ°å›¾æ§åˆ¶æŒ‰é’® -->
  <div class="map-controls">
    <button class="control-btn" id="arBtn" title="ARãƒŠãƒ“">ğŸ“±</button>
    <button class="control-btn" id="compassBtn" title="ã‚³ãƒ³ãƒ‘ã‚¹">ğŸ§­</button>
    <button class="control-btn" id="searchMapBtn" title="æ¤œç´¢">ğŸ”</button>
    <button class="control-btn" id="voiceBtn" title="éŸ³å£°ã‚¬ã‚¤ãƒ‰">ğŸ”Š</button>
  </div>

  <!-- åº•éƒ¨å¯¼èˆªæ  -->
  <div class="bottom-nav" id="bottomNav" style="display: none;">
    <div class="nav-info">
      <div class="nav-time" id="navTime">0 åˆ†</div>
      <div class="nav-distance" id="navDistance">0 mãƒ»åˆ°ç€äºˆå®š</div>
    </div>
    <div class="nav-controls">
      <button class="nav-control-btn" id="routeOptionsBtn">âš¡</button>
      <button class="nav-control-btn exit-btn" id="exitNavBtn">é€€å‡º</button>
    </div>
  </div>


<script>
  let map, directionsService, directionsRenderer, autocomplete;
  let origin = null;      // [lng, lat]
  let dest = null;        // [lng, lat]
  let travelMode = 'WALKING';
  let currentRoute = null;
  let currentStepIndex = 0;
  let navigationActive = false;
  let voiceEnabled = false;

  // ä» URL è·å–èµ·ç‚¹ï¼ˆç”±å°ç¨‹åºæ‹¼æ¥ï¼‰ï¼Œç¼ºçœäº¬éƒ½ç«™
  function getQueryFloat(name, def){ 
    const v = new URLSearchParams(location.search).get(name); 
    return v ? parseFloat(v) : def; 
  }

  function showStatus(type) {
    document.querySelectorAll('.status > div').forEach(el => el.style.display = 'none');
    document.getElementById(type).style.display = 'block';
    if (type !== 'loading') {
      setTimeout(() => {
        document.getElementById(type).style.display = 'none';
      }, 3000);
    }
  }

  function init(){
    const olng = getQueryFloat('olng', 135.759644); // äº¬éƒ½ç«™
    const olat = getQueryFloat('olat', 35.003118);
    origin = {lng: olng, lat: olat};

    map = new google.maps.Map(document.getElementById('map'), {
      center: origin, 
      zoom: 15, 
      disableDefaultUI: false,
      styles: [
        {
          featureType: "poi",
          elementType: "labels",
          stylers: [{ visibility: "off" }]
        }
      ]
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ 
      map,
      suppressMarkers: false,
      polylineOptions: {
        strokeColor: '#007AFF',
        strokeWeight: 4,
        strokeOpacity: 0.8
      },
      // å¯ç”¨ Google Maps åŸç”Ÿå¯¼èˆªåŠŸèƒ½
      draggable: true,
      hideRouteList: false,
      panel: null // ä½¿ç”¨é»˜è®¤çš„å¯¼èˆªé¢æ¿
    });

    // èµ·ç‚¹æ ‡è®° - æ›´æ˜æ˜¾çš„å½“å‰ä½ç½®
    new google.maps.Marker({ 
      position: origin, 
      map, 
      label: {
        text: 'ç¾åœ¨åœ°',
        color: '#fff',
        fontSize: '12px',
        fontWeight: 'bold'
      },
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 12,
        fillColor: '#007AFF',
        fillOpacity: 1,
        strokeColor: '#fff',
        strokeWeight: 3
      },
      title: 'ç¾åœ¨åœ°'
    });

    // è‡ªåŠ¨è¡¥å…¨
    const input = document.getElementById('search');
    autocomplete = new google.maps.places.Autocomplete(input, {
      fields: ['geometry','name','formatted_address'],
      types: ['establishment', 'geocode']
    });
    
    autocomplete.addListener('place_changed', () => {
      const place = autocomplete.getPlace();
      if (!place.geometry || !place.geometry.location) return;
      
      const ll = place.geometry.location;
      dest = { lng: ll.lng(), lat: ll.lat() };
      
      // æ¸…é™¤ä¹‹å‰çš„ç»ˆç‚¹æ ‡è®°
      const markers = map.markers || [];
      markers.forEach(marker => {
        if (marker.label === 'G') marker.setMap(null);
      });
      
      // æ·»åŠ æ–°çš„ç»ˆç‚¹æ ‡è®°
      const destMarker = new google.maps.Marker({ 
        position: dest, 
        map, 
        label: 'G',
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 8,
          fillColor: '#FF3B30',
          fillOpacity: 1,
          strokeColor: '#fff',
          strokeWeight: 2
        }
      });
      
      if (!map.markers) map.markers = [];
      map.markers.push(destMarker);
      
      map.panTo(dest);
      showStatus('success');
    });


    // æœç´¢æŒ‰é’®
    document.getElementById('searchBtn').onclick = () => {
      const keyword = document.getElementById('search').value.trim();
      if (keyword) {
        searchAndNavigate(keyword);
      }
    };
    
    // æ§åˆ¶æŒ‰é’®
    document.getElementById('arBtn').onclick = toggleAR;
    document.getElementById('compassBtn').onclick = toggleCompass;
    document.getElementById('searchMapBtn').onclick = () => {
      document.getElementById('search').focus();
    };
    document.getElementById('voiceBtn').onclick = toggleVoice;
    
    // åº•éƒ¨å¯¼èˆªæ§åˆ¶
    document.getElementById('routeOptionsBtn').onclick = showRouteOptions;
    document.getElementById('exitNavBtn').onclick = exitNavigation;

    // å°ç¨‹åº -> H5 çš„ä½ç½®æ›´æ–°ï¼šæ¥æ”¶ postMessage
    window.addEventListener('message', e => {
      const { type, payload } = e.data || {};
      if (type === 'setOrigin' && payload) {
        origin = { lng: payload.lng, lat: payload.lat };
        map.setCenter(origin);
        
        // æ›´æ–°èµ·ç‚¹æ ‡è®°
        const markers = map.markers || [];
        markers.forEach(marker => {
          if (marker.label === 'S') marker.setMap(null);
        });
        
        new google.maps.Marker({ 
          position: origin, 
          map, 
          label: 'S',
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: '#007AFF',
            fillOpacity: 1,
            strokeColor: '#fff',
            strokeWeight: 2
          }
        });
      }
      if (type === 'setDest' && payload) {
        dest = { lng: payload.lng, lat: payload.lat };
        
        // æ›´æ–°ç»ˆç‚¹æ ‡è®°
        const markers = map.markers || [];
        markers.forEach(marker => {
          if (marker.label === 'G') marker.setMap(null);
        });
        
        new google.maps.Marker({ 
          position: dest, 
          map, 
          label: 'G',
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: '#FF3B30',
            fillOpacity: 1,
            strokeColor: '#fff',
            strokeWeight: 2
          }
        });
        
        routeAndReport();
      }
    });
  }

  // æœç´¢å¹¶å¯¼èˆª
  function searchAndNavigate(keyword) {
    if (!origin) {
      showStatus('ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...');
      return;
    }
    
    // ä½¿ç”¨ Places API æœç´¢
    const request = {
      query: keyword,
      fields: ['geometry', 'name', 'formatted_address'],
      locationBias: new google.maps.LatLng(origin.lat, origin.lng)
    };
    
    const service = new google.maps.places.PlacesService(map);
    service.textSearch(request, (results, status) => {
      if (status === google.maps.places.PlacesServiceStatus.OK && results[0]) {
        const place = results[0];
        dest = {
          lat: place.geometry.location.lat(),
          lng: place.geometry.location.lng()
        };
        
        // æ·»åŠ ç›®çš„åœ°æ ‡è®°
        new google.maps.Marker({
          position: dest,
          map: map,
          title: place.name,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: '#FF3B30',
            fillOpacity: 1,
            strokeColor: '#fff',
            strokeWeight: 2
          }
        });
        
        // å¼€å§‹å¯¼èˆª
        startNavigation();
      } else {
        showStatus('å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
      }
    });
  }
  
  // å¼€å§‹å¯¼èˆª
  function startNavigation() {
    if (!origin || !dest) return;
    
    showStatus('ãƒ«ãƒ¼ãƒˆè¨ˆç®—ä¸­...');
    
    directionsService.route({
      origin: origin,
      destination: dest,
      travelMode: 'WALKING',
      avoidHighways: true,
      avoidTolls: true
    }, (res, status) => {
      if (status !== 'OK') {
        showStatus('ãƒ«ãƒ¼ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        return;
      }
      
      // æ˜¾ç¤ºè·¯çº¿
      directionsRenderer.setDirections(res);
      currentRoute = res.routes[0];
      currentStepIndex = 0;
      navigationActive = true;
      
      // æ˜¾ç¤ºå¯¼èˆªç•Œé¢
      showNavigationUI();
      
      // æ›´æ–°å¯¼èˆªä¿¡æ¯
      updateNavigationInfo();
      
      // å›ä¼ å°ç¨‹åº
      const leg = res.routes[0].legs[0];
      if (window.parent && window.parent.postMessage) {
        window.parent.postMessage({
          type: 'routeUpdate',
          payload: {
            distanceMeters: leg.distance.value,
            durationSeconds: leg.duration.value,
            mode: 'WALKING',
            origin: origin,
            destination: dest,
            route: res.routes[0]
          }
        }, '*');
      }
    });
  }
  
  // æ˜¾ç¤ºå¯¼èˆªç•Œé¢
  function showNavigationUI() {
    document.getElementById('navigationBanner').style.display = 'flex';
    document.getElementById('bottomNav').style.display = 'flex';
    document.getElementById('searchBar').style.display = 'none';
  }
  
  // æ›´æ–°å¯¼èˆªä¿¡æ¯
  function updateNavigationInfo() {
    if (!currentRoute || !navigationActive) return;
    
    const steps = currentRoute.legs[0].steps;
    const totalSteps = steps.length;
    
    if (currentStepIndex >= totalSteps) {
      // åˆ°è¾¾ç›®çš„åœ°
      document.getElementById('navStreet').textContent = 'ç›®çš„åœ°ã«åˆ°ç€ã—ã¾ã—ãŸï¼';
      document.getElementById('navDirection').textContent = '';
      document.getElementById('navArrow').textContent = 'âœ“';
      return;
    }
    
    const currentStep = steps[currentStepIndex];
    const instruction = currentStep.instructions.replace(/<[^>]*>/g, '');
    const distance = currentStep.distance ? currentStep.distance.text : '';
    
    // æ›´æ–°å¯¼èˆªæ¨ªå¹…
    document.getElementById('navStreet').textContent = instruction;
    document.getElementById('navDirection').textContent = distance;
    
    // æ›´æ–°ç®­å¤´æ–¹å‘
    updateNavigationArrow(currentStep);
    
    // æ›´æ–°åº•éƒ¨ä¿¡æ¯
    const leg = currentRoute.legs[0];
    const totalDistance = leg.distance.value;
    const totalDuration = leg.duration.value;
    
    document.getElementById('navTime').textContent = `${Math.round(totalDuration / 60)} åˆ†`;
    document.getElementById('navDistance').textContent = 
      `${totalDistance < 1000 ? Math.round(totalDistance) + 'm' : (totalDistance/1000).toFixed(2) + 'km'}ãƒ»åˆ°ç€äºˆå®š`;
  }
  
  // æ›´æ–°å¯¼èˆªç®­å¤´
  function updateNavigationArrow(step) {
    const arrow = document.getElementById('navArrow');
    const instruction = step.instructions.toLowerCase();
    
    if (instruction.includes('å·¦') || instruction.includes('left')) {
      arrow.textContent = 'â†';
    } else if (instruction.includes('å³') || instruction.includes('right')) {
      arrow.textContent = 'â†’';
    } else if (instruction.includes('ç›´é€²') || instruction.includes('straight')) {
      arrow.textContent = 'â†‘';
    } else if (instruction.includes('æˆ»ã‚‹') || instruction.includes('back')) {
      arrow.textContent = 'â†“';
    } else {
      arrow.textContent = 'â†‘';
    }
  }
  
  // æ§åˆ¶æŒ‰é’®åŠŸèƒ½
  function toggleAR() {
    showStatus('ARãƒŠãƒ“ã¯æº–å‚™ä¸­ã§ã™');
  }
  
  function toggleCompass() {
    const btn = document.getElementById('compassBtn');
    btn.classList.toggle('active');
    showStatus(btn.classList.contains('active') ? 'ã‚³ãƒ³ãƒ‘ã‚¹ã‚ªãƒ³' : 'ã‚³ãƒ³ãƒ‘ã‚¹ã‚ªãƒ•');
  }
  
  function toggleVoice() {
    voiceEnabled = !voiceEnabled;
    const btn = document.getElementById('voiceBtn');
    btn.classList.toggle('active');
    showStatus(voiceEnabled ? 'éŸ³å£°ã‚¬ã‚¤ãƒ‰ã‚ªãƒ³' : 'éŸ³å£°ã‚¬ã‚¤ãƒ‰ã‚ªãƒ•');
  }
  
  function showRouteOptions() {
    showStatus('ãƒ«ãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯æº–å‚™ä¸­ã§ã™');
  }
  
  function exitNavigation() {
    navigationActive = false;
    currentRoute = null;
    currentStepIndex = 0;
    
    // éšè—å¯¼èˆªç•Œé¢
    document.getElementById('navigationBanner').style.display = 'none';
    document.getElementById('bottomNav').style.display = 'none';
    document.getElementById('searchBar').style.display = 'block';
    
    // æ¸…é™¤è·¯çº¿
    directionsRenderer.setDirections({routes: []});
    
    showStatus('ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¾ã—ãŸ');
  }
  
  // çŠ¶æ€æ˜¾ç¤º
  function showStatus(message) {
    // åˆ›å»ºæˆ–æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
    let indicator = document.getElementById('statusIndicator');
    if (!indicator) {
      indicator = document.createElement('div');
      indicator.id = 'statusIndicator';
      indicator.className = 'status-indicator';
      document.body.appendChild(indicator);
    }
    
    indicator.textContent = message;
    indicator.classList.add('show');
    
    setTimeout(() => {
      indicator.classList.remove('show');
    }, 2000);
  }

  // å…¨å±€å›è°ƒï¼ˆç”± script çš„ callback=init è§¦å‘ï¼‰
  window.init = init;
</script>
</body>
</html>
