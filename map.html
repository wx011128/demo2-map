<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³</title>
  <style>
    html,body,#map{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
    .panel{position:absolute;top:10px;left:10px;right:10px;display:flex;gap:8px;z-index:10}
    .card{background:rgba(255,255,255,0.95);padding:12px 16px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.15);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.2)}
    .grow{flex:1}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{padding:8px 12px;border-radius:20px;border:1px solid #ddd;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s ease;background:#fff}
    .pill.active{background:#007AFF;color:#fff;border-color:#007AFF;transform:scale(1.05)}
    .pill:hover{transform:scale(1.02)}
    #search{padding:12px 16px;border:1px solid #ddd;border-radius:22px;font-size:16px;outline:none;flex:1;min-width:200px;height:44px;box-sizing:border-box}
    #search:focus{border-color:#007AFF;box-shadow:0 0 0 3px rgba(0,122,255,0.1)}
    #voiceBtn{padding:12px 16px;background:#007AFF;color:#fff;border:none;border-radius:22px;cursor:pointer;font-weight:600;transition:all 0.2s ease;height:44px;box-sizing:border-box;white-space:nowrap;font-size:14px}
    #voiceBtn:hover{background:#0056CC;transform:scale(1.05)}
    #searchBtn{padding:12px 20px;background:#007AFF;color:#fff;border:none;border-radius:22px;cursor:pointer;font-weight:600;transition:all 0.2s ease;height:44px;box-sizing:border-box;white-space:nowrap}
    #searchBtn:hover{background:#0056CC;transform:scale(1.05)}
    #go{padding:12px 20px;background:#007AFF;color:#fff;border:none;border-radius:22px;cursor:pointer;font-weight:600;transition:all 0.2s ease;height:44px;box-sizing:border-box;white-space:nowrap}
    #go:hover{background:#0056CC;transform:scale(1.05)}
    #go:disabled{background:#ccc;cursor:not-allowed;transform:none}
    #dist{margin-left:8px;color:#111;font-weight:600;font-size:14px;white-space:nowrap}
    /* è¿›åº¦æ¡æ ·å¼ */
    .progress-container {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 100;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #E5E5EA;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #007AFF, #34C759);
      border-radius: 4px;
      transition: width 0.5s ease;
      width: 0%;
    }
    
    .progress-text {
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    
    /* å…¨å±å¯¼èˆªç•Œé¢æ ·å¼ */
    .navigation-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: transparent;
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }
    
    /* å¯¼èˆªæŒ‡ä»¤æ¨ªå¹… */
    .instruction-banner {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      background: white;
      color: #333;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1001;
    }
    
    .direction-icon {
      font-size: 24px;
      font-weight: bold;
    }
    
    .instruction-text {
      flex: 1;
    }
    
    .current-street {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .next-action {
      font-size: 14px;
      opacity: 0.9;
    }
    
    /* åœ°å›¾å®¹å™¨ */
    .map-container {
      flex: 1;
      position: relative;
      background: #f0f0f0;
    }
    
    #navMap {
      width: 100%;
      height: 100%;
    }
    
    /* å³ä¾§çºµå‘è¿›åº¦æ¡ */
    .progress-sidebar {
      position: absolute;
      right: 20px;
      top: 160px;
      bottom: 160px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .progress-bar-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100%;
      position: relative;
    }
    
    .progress-bar-track {
      width: 8px;
      height: 100%;
      background: #E5E5EA;
      border-radius: 4px;
      position: relative;
      overflow: visible;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .progress-bar-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #4CAF50;
      border-radius: 4px;
      transition: height 0.5s ease;
      height: 0%;
    }
    
    .progress-indicator {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 16px;
      height: 16px;
      background: #4CAF50;
      border: 3px solid white;
      border-radius: 50%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: top 0.5s ease;
      top: 100%;
      z-index: 10;
      margin-top: -8px; /* ç¡®ä¿åœ†ç‚¹ä¸­å¿ƒåœ¨è¿›åº¦æ¡ä¸Š */
    }
    
    /* åº•éƒ¨ä¿¡æ¯é¢æ¿ */
    .bottom-panel {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: white;
      padding: 16px 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .info-content {
      display: flex;
      gap: 20px;
      flex: 1;
    }
    
    .info-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      flex: 1;
    }
    
    .info-label {
      font-size: 12px;
      color: #666;
      font-weight: 500;
    }
    
    .info-value {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }
    
    /* é€€å‡ºæŒ‰é’® */
    .exit-btn {
      background: #FF3B30;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .exit-btn:hover {
      background: #D70015;
      transform: scale(1.05);
    }
  </style>
  <!-- åŠ è½½ Google Maps JS + Places åº“ -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAhspEDXoZ63pYFyYaR2IpmwEDApsxsbU4&libraries=places&language=ja&region=JP&callback=init">
  </script>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
        <div class="card grow">
          <div class="row">
            <input id="search" placeholder="ç›®çš„åœ°ã‚’å…¥åŠ›" />
            <button id="voiceBtn">ğŸ¤ è¯­éŸ³</button>
            <button id="searchBtn">æ¤œç´¢</button>
            <button id="go" style="display: none;">é–‹å§‹</button>
            <span id="dist"></span>
          </div>
        </div>
  </div>

  <!-- è¿›åº¦æ¡ -->
  <div class="progress-container" id="progressContainer" style="display: none;">
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <div class="progress-text" id="progressText">0%</div>
  </div>

  <!-- å…¨å±å¯¼èˆªç•Œé¢ -->
  <div class="navigation-screen" id="navigationScreen" style="display: none;">
    <!-- å¯¼èˆªæŒ‡ä»¤æ¨ªå¹… -->
    <div class="instruction-banner">
      <div class="direction-icon">â†‘</div>
      <div class="instruction-text">
        <div class="current-street" id="currentStreet">å¸‚å ´ç­‹</div>
        <div class="next-action" id="nextAction">è”µå‰é€šã«å‘ã‹ã†</div>
      </div>
    </div>
    
    <!-- åœ°å›¾åŒºåŸŸ -->
    <div class="map-container">
      <div id="navMap"></div>
    </div>
    
    <!-- å³ä¾§çºµå‘è¿›åº¦æ¡ -->
    <div class="progress-sidebar">
      <div class="progress-bar-container">
        <div class="progress-bar-track">
          <div class="progress-bar-fill" id="progressBarFill"></div>
          <div class="progress-indicator" id="progressIndicator"></div>
        </div>
      </div>
    </div>
    
    <!-- åº•éƒ¨ä¿¡æ¯é¢æ¿ -->
    <div class="bottom-panel">
      <div class="info-content">
        <div class="info-item">
          <div class="info-label">æ®‹ã‚Šæ™‚é–“</div>
          <div class="info-value" id="remainingTime">6åˆ†</div>
        </div>
        <div class="info-item">
          <div class="info-label">æ®‹ã‚Šè·é›¢</div>
          <div class="info-value" id="remainingDistance">450m</div>
        </div>
        <div class="info-item">
          <div class="info-label">åˆ°ç€äºˆå®š</div>
          <div class="info-value" id="arrivalTime">11:02</div>
        </div>
        <div class="info-item">
          <button class="exit-btn" id="exitNav">çµ‚äº†</button>
        </div>
      </div>
    </div>
  </div>



<script>
  let map, directionsService, directionsRenderer, autocomplete;
  let navMap = null;      // å¯¼èˆªç•Œé¢çš„åœ°å›¾
  let origin = null;      // [lng, lat]
  let dest = null;        // [lng, lat]
  let travelMode = 'WALKING';
  let currentRoute = null;
  let progressInterval = null;
  let guideInterval = null;
  let currentStepIndex = 0;
  let currentLocationMarker = null;  // å½“å‰ä½ç½®æ ‡è®°
  let destinationMarker = null;      // ç›®çš„åœ°æ ‡è®°
  let currentLocation = null;        // å½“å‰å®é™…ä½ç½®
  let directionSector = null;        // æ–¹å‘æ‰‡å½¢
  let currentHeading = 0;            // å½“å‰æœå‘è§’åº¦ï¼ˆ0-360åº¦ï¼‰
  let recognition = null;            // è¯­éŸ³è¯†åˆ«å¯¹è±¡
  let isListening = false;           // æ˜¯å¦æ­£åœ¨ç›‘å¬

  // ä» URL è·å–èµ·ç‚¹ï¼ˆç”±å°ç¨‹åºæ‹¼æ¥ï¼‰ï¼Œç¼ºçœäº¬éƒ½ç«™
  function getQueryFloat(name, def){ 
    const v = new URLSearchParams(location.search).get(name); 
    return v ? parseFloat(v) : def; 
  }
  
  // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
  function initSpeechRecognition() {
    // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³è¯†åˆ«
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      console.warn('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯­éŸ³åŠŸèƒ½å°†ä¸å¯ç”¨');
      return false;
    }
    
    try {
      // åˆ›å»ºè¯­éŸ³è¯†åˆ«å¯¹è±¡
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
    } catch (error) {
      console.error('åˆ›å»ºè¯­éŸ³è¯†åˆ«å¯¹è±¡å¤±è´¥:', error);
      return false;
    }
    
    try {
      // é…ç½®è¯­éŸ³è¯†åˆ«
      recognition.continuous = false;  // ä¸è¿ç»­è¯†åˆ«
      recognition.interimResults = false;  // ä¸è¿”å›ä¸­é—´ç»“æœ
      recognition.lang = 'ja-JP';  // è®¾ç½®è¯­è¨€ä¸ºæ—¥è¯­
      recognition.maxAlternatives = 1;  // åªè¿”å›ä¸€ä¸ªç»“æœ
    } catch (error) {
      console.error('é…ç½®è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
      return false;
    }
    
    // è¯†åˆ«å¼€å§‹äº‹ä»¶
    recognition.onstart = function() {
      console.log('è¯­éŸ³è¯†åˆ«å¼€å§‹');
      isListening = true;
      updateVoiceButton();
      showVoiceStatus('æ­£åœ¨ç›‘å¬...');
    };
    
    // è¯†åˆ«ç»“æœäº‹ä»¶
    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript;
      console.log('è¯­éŸ³è¯†åˆ«ç»“æœ:', transcript);
      
      // å°†è¯†åˆ«ç»“æœå¡«å…¥æœç´¢æ¡†
      const searchInput = document.getElementById('search');
      searchInput.value = transcript;
      
      // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
      showVoiceStatus('è¯†åˆ«ç»“æœ: ' + transcript);
      
      // è‡ªåŠ¨æ‰§è¡Œæœç´¢
      searchPlaces();
    };
    
    // è¯†åˆ«ç»“æŸäº‹ä»¶
    recognition.onend = function() {
      console.log('è¯­éŸ³è¯†åˆ«ç»“æŸ');
      isListening = false;
      updateVoiceButton();
      hideVoiceStatus();
    };
    
    // è¯†åˆ«é”™è¯¯äº‹ä»¶
    recognition.onerror = function(event) {
      console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
      isListening = false;
      updateVoiceButton();
      
      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      let errorMessage = 'è¯­éŸ³è¯†åˆ«å¤±è´¥';
      switch(event.error) {
        case 'no-speech':
          errorMessage = 'æ²¡æœ‰æ£€æµ‹åˆ°è¯­éŸ³';
          break;
        case 'audio-capture':
          errorMessage = 'æ— æ³•è®¿é—®éº¦å…‹é£';
          break;
        case 'not-allowed':
          errorMessage = 'éº¦å…‹é£æƒé™è¢«æ‹’ç»';
          break;
        case 'network':
          errorMessage = 'ç½‘ç»œé”™è¯¯';
          break;
        default:
          errorMessage = 'è¯­éŸ³è¯†åˆ«é”™è¯¯: ' + event.error;
      }
      showVoiceStatus(errorMessage);
      setTimeout(hideVoiceStatus, 3000);
    };
    
    return true;
  }
  
  // å¼€å§‹è¯­éŸ³è¯†åˆ«
  function startVoiceRecognition() {
    console.log('ç‚¹å‡»è¯­éŸ³æŒ‰é’®');
    
    if (!recognition) {
      if (!initSpeechRecognition()) {
        console.warn('è¯­éŸ³è¯†åˆ«ä¸å¯ç”¨');
        showVoiceStatus('è¯­éŸ³è¯†åˆ«ä¸å¯ç”¨');
        setTimeout(hideVoiceStatus, 2000);
        return;
      }
    }
    
    if (isListening) {
      stopVoiceRecognition();
      return;
    }
    
    try {
      recognition.start();
    } catch (error) {
      console.error('å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
      showVoiceStatus('å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥');
      setTimeout(hideVoiceStatus, 2000);
    }
  }
  
  // åœæ­¢è¯­éŸ³è¯†åˆ«
  function stopVoiceRecognition() {
    if (recognition && isListening) {
      recognition.stop();
    }
  }
  
  // æ›´æ–°è¯­éŸ³æŒ‰é’®çŠ¶æ€
  function updateVoiceButton() {
    const voiceBtn = document.getElementById('voiceBtn');
    if (voiceBtn) {
      if (isListening) {
        voiceBtn.style.background = '#FF3B30';
        voiceBtn.innerHTML = 'ğŸ¤ åœæ­¢';
      } else {
        voiceBtn.style.background = '#007AFF';
        voiceBtn.innerHTML = 'ğŸ¤ è¯­éŸ³';
      }
    }
  }
  
  // æ˜¾ç¤ºè¯­éŸ³çŠ¶æ€
  function showVoiceStatus(message) {
    let statusDiv = document.getElementById('voiceStatus');
    if (!statusDiv) {
      statusDiv = document.createElement('div');
      statusDiv.id = 'voiceStatus';
      statusDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        z-index: 10000;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      `;
      document.body.appendChild(statusDiv);
    }
    
    statusDiv.textContent = message;
    statusDiv.style.display = 'block';
  }
  
  // éšè—è¯­éŸ³çŠ¶æ€
  function hideVoiceStatus() {
    const statusDiv = document.getElementById('voiceStatus');
    if (statusDiv) {
      statusDiv.style.display = 'none';
    }
  }

  // æœç´¢åœ°ç‚¹åŠŸèƒ½
  function searchPlaces() {
    console.log('å¼€å§‹æœç´¢');
    const query = document.getElementById('search').value.trim();
    if (!query) {
      console.log('æœç´¢æŸ¥è¯¢ä¸ºç©º');
      return;
    }
    
    // ç¡®ä¿ origin å­˜åœ¨
    if (!origin) {
      console.error('èµ·ç‚¹ä½ç½®æœªè®¾ç½®');
      alert('èµ·ç‚¹ä½ç½®æœªè®¾ç½®');
      return;
    }
    
    console.log('æœç´¢æŸ¥è¯¢:', query, 'èµ·ç‚¹ä½ç½®:', origin);
    
    const service = new google.maps.places.PlacesService(map);
    service.textSearch({
      query: query,
      location: origin,
      radius: 50000
    }, (results, status) => {
      console.log('æœç´¢çŠ¶æ€:', status, 'ç»“æœæ•°é‡:', results ? results.length : 0);
      if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
        // æ˜¾ç¤ºæœç´¢ç»“æœåˆ—è¡¨
        showSearchResults(results);
      } else {
        console.error('æœç´¢å¤±è´¥:', status);
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        alert('æœç´¢å¤±è´¥: ' + status);
      }
    });
  }

  // æ˜¾ç¤ºæœç´¢ç»“æœ
  function showSearchResults(results) {
    console.log('æ˜¾ç¤ºæœç´¢ç»“æœ:', results.length, 'ä¸ªç»“æœ');
    
    // åˆ›å»ºæœç´¢ç»“æœé¢æ¿
    let resultsPanel = document.getElementById('searchResults');
    if (!resultsPanel) {
      resultsPanel = document.createElement('div');
      resultsPanel.id = 'searchResults';
      resultsPanel.style.cssText = `
        position: absolute;
        top: 60px;
        left: 10px;
        right: 10px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 6px 18px rgba(0,0,0,.12);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
      `;
      document.body.appendChild(resultsPanel);
    }
    
    resultsPanel.innerHTML = results.map((place, index) => `
      <div style="padding: 12px 16px; border-bottom: 1px solid #eee; cursor: pointer;" 
           onclick="selectPlace(${index})">
        <div style="font-weight: 600; color: #333;">${place.name}</div>
        <div style="font-size: 12px; color: #666; margin-top: 4px;">${place.formatted_address}</div>
      </div>
    `).join('');
    
    // æ˜¾ç¤ºæœç´¢ç»“æœé¢æ¿
    resultsPanel.style.display = 'block';
    
    // å­˜å‚¨æœç´¢ç»“æœ
    window.searchResults = results;
  }

  // é€‰æ‹©åœ°ç‚¹
  function selectPlace(index) {
    console.log('é€‰æ‹©åœ°ç‚¹:', index);
    const place = window.searchResults[index];
    if (!place) {
      console.error('åœ°ç‚¹ä¸å­˜åœ¨:', index);
      return;
    }
    
    const ll = place.geometry.location;
    dest = { lng: ll.lng(), lat: ll.lat() };
    
    console.log('è®¾ç½®ç›®çš„åœ°:', dest);
    
    // æ¸…é™¤ä¹‹å‰çš„ç»ˆç‚¹æ ‡è®°
    const markers = map.markers || [];
    markers.forEach(marker => {
      if (marker.title === 'ç›®çš„åœ°') marker.setMap(null);
    });
    
    // æ·»åŠ æ–°çš„ç»ˆç‚¹æ ‡è®°
    const destMarker = new google.maps.Marker({ 
      position: dest, 
      map, 
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 8,
        fillColor: '#FF3B30',
        fillOpacity: 1,
        strokeColor: '#fff',
        strokeWeight: 2
      },
      title: 'ç›®çš„åœ°'
    });
    
    if (!map.markers) map.markers = [];
    map.markers.push(destMarker);
    
    map.panTo(dest);
    document.getElementById('go').style.display = 'inline-block';
    
    // éšè—æœç´¢ç»“æœ
    const resultsPanel = document.getElementById('searchResults');
    if (resultsPanel) resultsPanel.style.display = 'none';
    
    console.log('ç›®çš„åœ°è®¾ç½®å®Œæˆ');
  }


  function init(){
    console.log('å¼€å§‹åˆå§‹åŒ–åœ°å›¾');
    
    const olng = getQueryFloat('olng', 135.759644); // äº¬éƒ½ç«™
    const olat = getQueryFloat('olat', 35.003118);
    origin = {lng: olng, lat: olat};
    
    console.log('åˆå§‹åŒ–èµ·ç‚¹ä½ç½®:', origin);

    map = new google.maps.Map(document.getElementById('map'), {
      center: origin, 
      zoom: 15, 
      disableDefaultUI: false,
      styles: [
        {
          featureType: "poi",
          elementType: "labels",
          stylers: [{ visibility: "off" }]
        }
      ]
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ 
      map,
      suppressMarkers: false,
      polylineOptions: {
        strokeColor: '#007AFF',
        strokeWeight: 6,
        strokeOpacity: 0.9
      },
      preserveViewport: false
    });

    // èµ·ç‚¹æ ‡è®° - æ›´æ˜æ˜¾çš„å½“å‰ä½ç½®
    const originMarker = new google.maps.Marker({ 
      position: origin, 
      map, 
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 8,
        fillColor: '#007AFF',
        fillOpacity: 1,
        strokeColor: '#fff',
        strokeWeight: 2
      },
      title: 'ç¾åœ¨åœ°'
    });
    
    // å°†æ ‡è®°æ·»åŠ åˆ°åœ°å›¾çš„æ ‡è®°æ•°ç»„ä¸­
    if (!map.markers) map.markers = [];
    map.markers.push(originMarker);
    
    // åœ¨ä¸»åœ°å›¾ä¸Šä¹Ÿåˆ›å»ºæ–¹å‘æ‰‡å½¢
    createDirectionSector(origin, currentHeading, map);

    // è‡ªåŠ¨è¡¥å…¨
    const input = document.getElementById('search');
    autocomplete = new google.maps.places.Autocomplete(input, {
      fields: ['geometry','name','formatted_address'],
      types: ['establishment', 'geocode']
    });
    
    autocomplete.addListener('place_changed', () => {
      const place = autocomplete.getPlace();
      if (!place.geometry || !place.geometry.location) return;
      
      const ll = place.geometry.location;
      dest = { lng: ll.lng(), lat: ll.lat() };
      
      // æ¸…é™¤ä¹‹å‰çš„ç»ˆç‚¹æ ‡è®°
      const markers = map.markers || [];
      markers.forEach(marker => {
        if (marker.title === 'ç›®çš„åœ°') marker.setMap(null);
      });
      
      // æ·»åŠ æ–°çš„ç»ˆç‚¹æ ‡è®°
      const destMarker = new google.maps.Marker({ 
        position: dest, 
        map, 
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 8,
          fillColor: '#FF3B30',
          fillOpacity: 1,
          strokeColor: '#fff',
          strokeWeight: 2
        },
        title: 'ç›®çš„åœ°'
      });
      
      if (!map.markers) map.markers = [];
      map.markers.push(destMarker);
      
      map.panTo(dest);
      document.getElementById('go').style.display = 'inline-block';
    });


    // è¯­éŸ³æŒ‰é’®
    const voiceBtn = document.getElementById('voiceBtn');
    if (voiceBtn) {
      voiceBtn.onclick = startVoiceRecognition;
      console.log('è¯­éŸ³æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
    } else {
      console.error('è¯­éŸ³æŒ‰é’®æœªæ‰¾åˆ°');
    }
    
    // æœç´¢æŒ‰é’®
    const searchBtn = document.getElementById('searchBtn');
    if (searchBtn) {
      searchBtn.onclick = searchPlaces;
      console.log('æœç´¢æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
    } else {
      console.error('æœç´¢æŒ‰é’®æœªæ‰¾åˆ°');
    }
    
    // å¼€å§‹å¯¼èˆªï¼ˆè®¡ç®—è·¯çº¿ï¼‰
    document.getElementById('go').onclick = routeAndReport;
    
    // é€€å‡ºå¯¼èˆª
    document.getElementById('exitNav').onclick = exitNavigation;
    
    // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
    try {
      initSpeechRecognition();
    } catch (error) {
      console.error('è¯­éŸ³è¯†åˆ«åˆå§‹åŒ–å¤±è´¥:', error);
    }
    
    // æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
    console.log('åœ°å›¾åˆå§‹åŒ–å®Œæˆ');
    console.log('èµ·ç‚¹ä½ç½®:', origin);
    console.log('åœ°å›¾å¯¹è±¡:', map);
    console.log('è¯­éŸ³è¯†åˆ«å¯¹è±¡:', recognition);

    // å°ç¨‹åº -> H5 çš„ä½ç½®æ›´æ–°ï¼šæ¥æ”¶ postMessage
    window.addEventListener('message', e => {
      const { type, payload } = e.data || {};
      if (type === 'setOrigin' && payload) {
        origin = { lng: payload.lng, lat: payload.lat };
        map.setCenter(origin);
        
        // æ›´æ–°èµ·ç‚¹æ ‡è®°
        const markers = map.markers || [];
        markers.forEach(marker => {
          if (marker.title === 'ç¾åœ¨åœ°') marker.setMap(null);
        });
        
        const newOriginMarker = new google.maps.Marker({ 
          position: origin, 
          map, 
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: '#007AFF',
            fillOpacity: 1,
            strokeColor: '#fff',
            strokeWeight: 2
          },
          title: 'ç¾åœ¨åœ°'
        });
        
        // å°†æ–°æ ‡è®°æ·»åŠ åˆ°åœ°å›¾çš„æ ‡è®°æ•°ç»„ä¸­
        if (!map.markers) map.markers = [];
        map.markers.push(newOriginMarker);
      }
      if (type === 'setDest' && payload) {
        dest = { lng: payload.lng, lat: payload.lat };
        
        // æ›´æ–°ç»ˆç‚¹æ ‡è®°
        const markers = map.markers || [];
        markers.forEach(marker => {
          if (marker.title === 'ç›®çš„åœ°') marker.setMap(null);
        });
        
        const newDestMarker = new google.maps.Marker({ 
          position: dest, 
          map, 
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: '#FF3B30',
            fillOpacity: 1,
            strokeColor: '#fff',
            strokeWeight: 2
          },
          title: 'ç›®çš„åœ°'
        });
        
        // å°†æ–°æ ‡è®°æ·»åŠ åˆ°åœ°å›¾çš„æ ‡è®°æ•°ç»„ä¸­
        if (!map.markers) map.markers = [];
        map.markers.push(newDestMarker);
        
        routeAndReport();
      }
    });
  }

  async function routeAndReport(){
    if (!origin || !dest) {
      return alert('å‡ºç™ºåœ°/ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„');
    }
    
    document.getElementById('go').disabled = true;
    
    directionsService.route({
      origin, 
      destination: dest, 
      travelMode: 'WALKING',
      avoidHighways: true,
      avoidTolls: true
    }, (res, status) => {
      document.getElementById('go').disabled = false;
      
      if (status !== 'OK') {
        return alert('ãƒ«ãƒ¼ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + status);
      }
      
        directionsRenderer.setDirections(res);
        const leg = res.routes[0].legs[0];
        const meters = leg.distance.value;       // ç±³
        const seconds = leg.duration.value;      // ç§’

        document.getElementById('dist').textContent =
          `è·é›¢ ${meters < 1000 ? Math.round(meters) + 'm' : (meters/1000).toFixed(2) + 'km'}ãƒ»ç´„ ${Math.round(seconds/60)} åˆ†`;

        // ä¿å­˜è·¯çº¿å¹¶è¿›å…¥å¯¼èˆªç•Œé¢
        currentRoute = res.routes[0];
        currentStepIndex = 0;
        
        // ç¡®ä¿è·¯çº¿åœ¨åœ°å›¾ä¸Šæ­£ç¡®æ˜¾ç¤º
        console.log('è·¯çº¿å·²è®¡ç®—ï¼Œå¼€å§‹æ˜¾ç¤ºè·¯çº¿');
        
        enterNavigationMode();

      // å›ä¼ å°ç¨‹åº
      if (window.parent && window.parent.postMessage) {
        window.parent.postMessage({
          type: 'routeUpdate',
          payload: {
            distanceMeters: meters,
            durationSeconds: seconds,
            mode: 'WALKING',
            origin: origin,
            destination: dest,
            route: res.routes[0]
          }
        }, '*');
      }
    });
  }

  // å¼€å§‹è¿›åº¦è·Ÿè¸ª
  function startProgressTracking() {
    if (!currentRoute) return;
    
    // è·å–æ€»è·ç¦»
    const totalDistance = currentRoute.legs[0].distance.value; // ç±³
    let lastKnownLocation = null; // ä¸Šæ¬¡å·²çŸ¥ä½ç½®
    let totalTraveledDistance = 0; // æ€»å·²èµ°è·ç¦»
    
    // åˆå§‹åŒ–è¿›åº¦ä¸º0
    updateProgress(0);
    
    // ç¡®ä¿åœ†ç‚¹åˆå§‹ä½ç½®åœ¨è¿›åº¦æ¡åº•éƒ¨
    const progressIndicator = document.getElementById('progressIndicator');
    if (progressIndicator) {
      progressIndicator.style.top = '100%';
      progressIndicator.style.marginTop = '-8px';
    }
    
    // åŸºäºå®é™…ä½ç½®æ›´æ–°è¿›åº¦
    progressInterval = setInterval(() => {
      if (currentLocation) {
        // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è·å–ä½ç½®ï¼Œè®°å½•ä¸ºèµ·å§‹ä½ç½®
        if (!lastKnownLocation) {
          lastKnownLocation = currentLocation;
          return;
        }
        
        // è®¡ç®—ä»ä¸Šæ¬¡ä½ç½®åˆ°å½“å‰ä½ç½®çš„è·ç¦»
        const distanceMoved = calculateDistance(lastKnownLocation, currentLocation);
        
        // åªæœ‰å½“ç”¨æˆ·çœŸæ­£ç§»åŠ¨äº†ï¼ˆç§»åŠ¨è·ç¦»å¤§äº5ç±³ï¼‰æ—¶æ‰æ›´æ–°è¿›åº¦
        if (distanceMoved > 5) {
          totalTraveledDistance += distanceMoved;
          const progress = Math.max(0, Math.min(100, (totalTraveledDistance / totalDistance) * 100));
          
          updateProgress(progress);
          
          // æ›´æ–°å½“å‰ä½ç½®æ ‡è®°
          if (currentLocationMarker) {
            currentLocationMarker.setPosition(currentLocation);
          }
          
          // æ›´æ–°æ–¹å‘æ‰‡å½¢
          if (directionSector && navMap) {
            updateDirectionSector(currentLocation, currentHeading, navMap);
          }
          
          // æ›´æ–°ä¸»åœ°å›¾ä¸­çš„å½“å‰ä½ç½®æ ‡è®°
          if (map.markers) {
            map.markers.forEach(marker => {
              if (marker.title === 'ç¾åœ¨åœ°') {
                marker.setPosition(currentLocation);
              }
            });
          }
          
          // æ›´æ–°ä¸»åœ°å›¾ä¸­å¿ƒ
          map.setCenter(currentLocation);
          
          // æ›´æ–°ä¸Šæ¬¡å·²çŸ¥ä½ç½®
          lastKnownLocation = currentLocation;
          
          console.log('ç”¨æˆ·ç§»åŠ¨äº†', distanceMoved.toFixed(2), 'ç±³ï¼Œæ€»è¿›åº¦:', progress.toFixed(2) + '%');
        }
        
        // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾ç›®çš„åœ°ï¼ˆè·ç¦»å°äº50ç±³ï¼‰
        const distanceToDestination = calculateDistance(currentLocation, dest);
        if (distanceToDestination < 50) {
          updateProgress(100);
          clearInterval(progressInterval);
          console.log('å·²åˆ°è¾¾ç›®çš„åœ°ï¼');
        }
      }
    }, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡ä½ç½®å˜åŒ–ï¼Œä¸ä½ç½®æ›´æ–°åŒæ­¥
  }

  // è®¡ç®—ä¸¤ç‚¹é—´è·ç¦»ï¼ˆç±³ï¼‰
  function calculateDistance(pos1, pos2) {
    const R = 6371000; // åœ°çƒåŠå¾„ï¼ˆç±³ï¼‰
    const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
    const dLng = (pos2.lng - pos1.lng) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }
  
  // åˆ›å»ºæ–¹å‘æ‰‡å½¢
  function createDirectionSector(position, heading, map) {
    // åˆ é™¤æ—§çš„æ–¹å‘æ‰‡å½¢
    if (directionSector) {
      directionSector.setMap(null);
    }
    
    // æ‰‡å½¢å‚æ•°
    const radius = 50; // æ‰‡å½¢åŠå¾„ï¼ˆç±³ï¼‰
    const angle = 60;  // æ‰‡å½¢è§’åº¦ï¼ˆåº¦ï¼‰
    
    // è®¡ç®—æ‰‡å½¢çš„ä¸‰ä¸ªé¡¶ç‚¹
    const center = new google.maps.LatLng(position.lat, position.lng);
    
    // æ‰‡å½¢é¡¶ç‚¹1ï¼ˆå·¦è¾¹ç•Œï¼‰
    const leftAngle = heading - angle / 2;
    const leftPoint = google.maps.geometry.spherical.computeOffset(center, radius, leftAngle);
    
    // æ‰‡å½¢é¡¶ç‚¹2ï¼ˆå³è¾¹ç•Œï¼‰
    const rightAngle = heading + angle / 2;
    const rightPoint = google.maps.geometry.spherical.computeOffset(center, radius, rightAngle);
    
    // åˆ›å»ºæ‰‡å½¢å¤šè¾¹å½¢
    directionSector = new google.maps.Polygon({
      paths: [center, leftPoint, rightPoint],
      fillColor: '#007AFF',
      fillOpacity: 0.2,
      strokeColor: '#007AFF',
      strokeOpacity: 0.4,
      strokeWeight: 1,
      map: map
    });
    
    return directionSector;
  }
  
  // æ›´æ–°æ–¹å‘æ‰‡å½¢
  function updateDirectionSector(position, heading, map) {
    if (!directionSector) {
      createDirectionSector(position, heading, map);
      return;
    }
    
    // æ‰‡å½¢å‚æ•°
    const radius = 50; // æ‰‡å½¢åŠå¾„ï¼ˆç±³ï¼‰
    const angle = 60;  // æ‰‡å½¢è§’åº¦ï¼ˆåº¦ï¼‰
    
    // è®¡ç®—æ‰‡å½¢çš„ä¸‰ä¸ªé¡¶ç‚¹
    const center = new google.maps.LatLng(position.lat, position.lng);
    
    // æ‰‡å½¢é¡¶ç‚¹1ï¼ˆå·¦è¾¹ç•Œï¼‰
    const leftAngle = heading - angle / 2;
    const leftPoint = google.maps.geometry.spherical.computeOffset(center, radius, leftAngle);
    
    // æ‰‡å½¢é¡¶ç‚¹2ï¼ˆå³è¾¹ç•Œï¼‰
    const rightAngle = heading + angle / 2;
    const rightPoint = google.maps.geometry.spherical.computeOffset(center, radius, rightAngle);
    
    // æ›´æ–°æ‰‡å½¢è·¯å¾„
    directionSector.setPaths([center, leftPoint, rightPoint]);
  }
  
  // æ›´æ–°è¿›åº¦æ¡
  function updateProgress(percentage) {
    const progressBarFill = document.getElementById('progressBarFill');
    const progressIndicator = document.getElementById('progressIndicator');
    
    // æ›´æ–°çºµå‘è¿›åº¦æ¡
    progressBarFill.style.height = percentage + '%';
    
    // åœ†ç‚¹åº”è¯¥åœ¨ç»¿è‰²å¡«å……çš„é¡¶éƒ¨
    // ç”±äºè¿›åº¦æ¡ä»åº•éƒ¨å¼€å§‹å¡«å……ï¼Œåœ†ç‚¹ä½ç½®åº”è¯¥æ˜¯ (100 - percentage)%
    // ä½†æ˜¯è¦ç¡®ä¿åœ†ç‚¹ä¸ä¼šè¶…å‡ºè¿›åº¦æ¡èŒƒå›´
    let indicatorTop = 100 - percentage;
    
    // ç¡®ä¿åœ†ç‚¹å§‹ç»ˆåœ¨è¿›åº¦æ¡èŒƒå›´å†…
    if (indicatorTop < 0) {
      indicatorTop = 0;
    } else if (indicatorTop > 100) {
      indicatorTop = 100;
    }
    
    // è°ƒæ•´åœ†ç‚¹ä½ç½®ï¼Œç¡®ä¿å®ƒè¦†ç›–åœ¨è¿›åº¦æ¡ä¸Š
    progressIndicator.style.top = indicatorTop + '%';
    progressIndicator.style.marginTop = '-8px'; // ç¡®ä¿åœ†ç‚¹ä¸­å¿ƒåœ¨è¿›åº¦æ¡ä¸Š
    
    // ç¡®ä¿åœ†ç‚¹ä¸ä¼šè¶…å‡ºè¿›åº¦æ¡èŒƒå›´
    if (indicatorTop <= 0) {
      progressIndicator.style.top = '0%';
      progressIndicator.style.marginTop = '-8px';
    } else if (indicatorTop >= 100) {
      progressIndicator.style.top = '100%';
      progressIndicator.style.marginTop = '-8px';
    }
    
    console.log('è¿›åº¦æ›´æ–°:', percentage + '%', 'åœ†ç‚¹ä½ç½®:', indicatorTop + '%');
  }
  
  // åœæ­¢è¿›åº¦è·Ÿè¸ª
  function stopProgressTracking() {
    if (progressInterval) {
      clearInterval(progressInterval);
      progressInterval = null;
    }
    document.getElementById('progressContainer').style.display = 'none';
  }
  
  // è¿›å…¥å¯¼èˆªæ¨¡å¼
  function enterNavigationMode() {
    if (!currentRoute) return;
    
    // éšè—ä¸»ç•Œé¢ï¼Œæ˜¾ç¤ºå¯¼èˆªç•Œé¢
    document.getElementById('map').style.display = 'none';
    document.getElementById('navigationScreen').style.display = 'flex';
    
    // åˆå§‹åŒ–å¯¼èˆªåœ°å›¾
    initNavigationMap();
    
    // æ›´æ–°å¯¼èˆªä¿¡æ¯
    updateNavigationInfo();
    
    // åˆå§‹åŒ–è¿›åº¦æ¡ä¸º0
    updateProgress(0);
    
    // ç¡®ä¿åœ†ç‚¹åˆå§‹ä½ç½®åœ¨è¿›åº¦æ¡åº•éƒ¨
    const progressIndicator = document.getElementById('progressIndicator');
    if (progressIndicator) {
      progressIndicator.style.top = '100%';
      progressIndicator.style.marginTop = '-8px';
    }
    
    // å¼€å§‹æ¨¡æ‹Ÿä½ç½®æ›´æ–°ï¼ˆç”¨äºæµ‹è¯•ï¼‰
    startLocationSimulation();
    
    // å»¶è¿Ÿå¼€å§‹è¿›åº¦è·Ÿè¸ªï¼Œç¡®ä¿ä½ç½®æ¨¡æ‹Ÿå…ˆå¼€å§‹
    setTimeout(() => {
      startProgressTracking();
    }, 1000);
    
    // å®šæœŸæ›´æ–°å¯¼èˆªä¿¡æ¯
    guideInterval = setInterval(() => {
      updateNavigationInfo();
    }, 3000); // æ¯3ç§’æ›´æ–°ä¸€æ¬¡ï¼Œé¿å…è¿‡åº¦æ›´æ–°
  }

  // å¼€å§‹ä½ç½®æ›´æ–°ï¼ˆåŸºäºå°ç¨‹åºä¼ é€’çš„ä½ç½®ï¼‰
  function startLocationSimulation() {
    // ä½¿ç”¨å°ç¨‹åºä¼ é€’çš„ä½ç½®ä½œä¸ºåˆå§‹ä½ç½®
    currentLocation = { lat: origin.lat, lng: origin.lng };
    
    console.log('ä½¿ç”¨å°ç¨‹åºä¼ é€’çš„ä½ç½®:', currentLocation);
    
    // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå°ç¨‹åºä¼šå®šæœŸæ›´æ–°URLå‚æ•°æ¥ä¼ é€’æ–°ä½ç½®
    // è¿™é‡Œæˆ‘ä»¬ç›‘å¬URLå˜åŒ–æ¥è·å–æ–°ä½ç½®
    let lastUrl = location.href;
    const urlCheckInterval = setInterval(() => {
      if (location.href !== lastUrl) {
        // URLå‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°è·å–ä½ç½®å‚æ•°
        const newOlat = getQueryFloat('olat', origin.lat);
        const newOlng = getQueryFloat('olng', origin.lng);
        
        if (newOlat !== origin.lat || newOlng !== origin.lng) {
          origin = { lat: newOlat, lng: newOlng };
          currentLocation = { lat: newOlat, lng: newOlng };
          console.log('ä½ç½®æ›´æ–°:', currentLocation);
          
          // æ›´æ–°å¯¼èˆªåœ°å›¾ä¸­çš„å½“å‰ä½ç½®æ ‡è®°
          if (currentLocationMarker) {
            currentLocationMarker.setPosition(currentLocation);
          }
          
          // æ›´æ–°æ–¹å‘æ‰‡å½¢
          if (directionSector && navMap) {
            updateDirectionSector(currentLocation, currentHeading, navMap);
          }
          
          // æ›´æ–°ä¸»åœ°å›¾ä¸­çš„å½“å‰ä½ç½®æ ‡è®°
          if (map.markers) {
            map.markers.forEach(marker => {
              if (marker.title === 'ç¾åœ¨åœ°') {
                marker.setPosition(currentLocation);
              }
            });
          }
          
          // æ›´æ–°ä¸»åœ°å›¾ä¸­å¿ƒ
          map.setCenter(currentLocation);
        }
        
        lastUrl = location.href;
      }
    }, 1000); // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡URLå˜åŒ–
    
    // æ¨¡æ‹Ÿæœå‘å˜åŒ–ï¼ˆç”¨äºæµ‹è¯•ï¼‰
    startHeadingSimulation();
  }
  
  // å¼€å§‹æœå‘æ¨¡æ‹Ÿï¼ˆç”¨äºæµ‹è¯•ï¼‰
  function startHeadingSimulation() {
    // æ¨¡æ‹Ÿæœå‘å˜åŒ–ï¼Œæ¯5ç§’æ”¹å˜ä¸€æ¬¡æœå‘
    setInterval(() => {
      if (directionSector && navMap && currentLocation) {
        // éšæœºæ”¹å˜æœå‘è§’åº¦ï¼ˆ0-360åº¦ï¼‰
        currentHeading = (currentHeading + Math.random() * 60 - 30) % 360;
        if (currentHeading < 0) currentHeading += 360;
        
        // æ›´æ–°æ–¹å‘æ‰‡å½¢
        updateDirectionSector(currentLocation, currentHeading, navMap);
        
        console.log('æœå‘æ›´æ–°:', currentHeading + 'åº¦');
      }
    }, 5000); // æ¯5ç§’æ›´æ–°ä¸€æ¬¡æœå‘
  }
  
  // é€€å‡ºå¯¼èˆªæ¨¡å¼
  function exitNavigation() {
    // æ˜¾ç¤ºä¸»ç•Œé¢ï¼Œéšè—å¯¼èˆªç•Œé¢
    document.getElementById('map').style.display = 'block';
    document.getElementById('navigationScreen').style.display = 'none';
    
    // åœæ­¢æ‰€æœ‰å®šæ—¶å™¨
    if (guideInterval) {
      clearInterval(guideInterval);
      guideInterval = null;
    }
    stopProgressTracking();
    
    // åœæ­¢è¯­éŸ³è¯†åˆ«
    stopVoiceRecognition();
    
    // é‡ç½®æœç´¢ç•Œé¢
    document.getElementById('search').value = '';
    document.getElementById('search').placeholder = 'ç›®çš„åœ°ã‚’å…¥åŠ›';
    document.getElementById('go').style.display = 'none';
    document.getElementById('dist').textContent = '';
    
    // éšè—æœç´¢ç»“æœé¢æ¿
    const resultsPanel = document.getElementById('searchResults');
    if (resultsPanel) resultsPanel.style.display = 'none';
    
    // æ¸…é™¤åœ°å›¾ä¸Šçš„è·¯çº¿å’Œæ ‡è®°
    if (directionsRenderer) {
      directionsRenderer.setDirections({routes: []});
    }
    
    // æ¸…é™¤æ‰€æœ‰æ ‡è®°
    if (map.markers) {
      map.markers.forEach(marker => marker.setMap(null));
      map.markers = [];
    }
    
    // æ¸…é™¤æ–¹å‘æ‰‡å½¢
    if (directionSector) {
      directionSector.setMap(null);
      directionSector = null;
    }
    
    // é‡æ–°æ·»åŠ èµ·ç‚¹æ ‡è®°
    const resetOriginMarker = new google.maps.Marker({ 
      position: origin, 
      map, 
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 8,
        fillColor: '#007AFF',
        fillOpacity: 1,
        strokeColor: '#fff',
        strokeWeight: 2
      },
      title: 'ç¾åœ¨åœ°'
    });
    
    // å°†æ ‡è®°æ·»åŠ åˆ°åœ°å›¾çš„æ ‡è®°æ•°ç»„ä¸­
    if (!map.markers) map.markers = [];
    map.markers.push(resetOriginMarker);
    
    // é‡ç½®å˜é‡
    dest = null;
    currentRoute = null;
    currentStepIndex = 0;
    
    console.log('å·²é€€å‡ºå¯¼èˆªï¼Œå›åˆ°æœç´¢é¡µé¢');
  }
  
  // åˆå§‹åŒ–å¯¼èˆªåœ°å›¾
  function initNavigationMap() {
    if (navMap) return; // å·²ç»åˆå§‹åŒ–è¿‡äº†
    
    console.log('åˆå§‹åŒ–å¯¼èˆªåœ°å›¾ï¼Œèµ·ç‚¹:', origin, 'ç»ˆç‚¹:', dest);
    
    navMap = new google.maps.Map(document.getElementById('navMap'), {
      center: origin,
      zoom: 16,
      disableDefaultUI: true,
      styles: [
        {
          featureType: "poi",
          elementType: "labels",
          stylers: [{ visibility: "off" }]
        }
      ]
    });
    
    // æ·»åŠ èµ·ç‚¹æ ‡è®°
    currentLocationMarker = new google.maps.Marker({
      position: origin,
      map: navMap,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 8,
        fillColor: '#007AFF',
        fillOpacity: 1,
        strokeColor: '#fff',
        strokeWeight: 2
      },
      title: 'ç¾åœ¨åœ°'
    });
    
    // å°†æ ‡è®°æ·»åŠ åˆ°åœ°å›¾çš„æ ‡è®°æ•°ç»„ä¸­
    if (!navMap.markers) navMap.markers = [];
    navMap.markers.push(currentLocationMarker);
    
    // åˆ›å»ºæ–¹å‘æ‰‡å½¢ï¼ˆåˆå§‹æœå‘åŒ—æ–¹ï¼‰
    createDirectionSector(origin, currentHeading, navMap);
    
    // æ·»åŠ ç»ˆç‚¹æ ‡è®°
    if (dest) {
      destinationMarker = new google.maps.Marker({
        position: dest,
        map: navMap,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 8,
          fillColor: '#FF3B30',
          fillOpacity: 1,
          strokeColor: '#fff',
          strokeWeight: 2
        },
        title: 'ç›®çš„åœ°'
      });
      
      // å°†æ ‡è®°æ·»åŠ åˆ°åœ°å›¾çš„æ ‡è®°æ•°ç»„ä¸­
      if (!navMap.markers) navMap.markers = [];
      navMap.markers.push(destinationMarker);
    }
    
    // æ·»åŠ è·¯çº¿åˆ°å¯¼èˆªåœ°å›¾
    const navDirectionsRenderer = new google.maps.DirectionsRenderer({
      map: navMap,
      suppressMarkers: true, // ä½¿ç”¨è‡ªå®šä¹‰æ ‡è®°
      polylineOptions: {
        strokeColor: '#007AFF',
        strokeWeight: 6,
        strokeOpacity: 0.9
      },
      preserveViewport: false
    });
    
    // ç¡®ä¿è·¯çº¿æ­£ç¡®æ˜¾ç¤º
    if (currentRoute) {
      console.log('è®¾ç½®å¯¼èˆªè·¯çº¿:', currentRoute);
      
      // åˆ›å»ºå®Œæ•´çš„è·¯çº¿å¯¹è±¡
      const directionsResult = {
        routes: [currentRoute],
        request: {
          origin: origin,
          destination: dest,
          travelMode: 'WALKING'
        }
      };
      
      navDirectionsRenderer.setDirections(directionsResult);
      
      // è°ƒæ•´åœ°å›¾è§†å›¾ä»¥æ˜¾ç¤ºå®Œæ•´è·¯çº¿
      const bounds = new google.maps.LatLngBounds();
      bounds.extend(origin);
      bounds.extend(dest);
      navMap.fitBounds(bounds);
      
      console.log('è·¯çº¿å·²è®¾ç½®åˆ°å¯¼èˆªåœ°å›¾');
    } else {
      console.error('æ²¡æœ‰è·¯çº¿æ•°æ®å¯ä»¥æ˜¾ç¤º');
    }
  }
  
  // æ›´æ–°å¯¼èˆªä¿¡æ¯
  function updateNavigationInfo() {
    if (!currentRoute || !currentLocation) return;
    
    const steps = currentRoute.legs[0].steps;
    const totalSteps = steps.length;
    
    // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾ç›®çš„åœ°
    const distanceToDestination = calculateDistance(currentLocation, dest);
    if (distanceToDestination < 50) {
      document.getElementById('currentStreet').textContent = 'ç›®çš„åœ°åˆ°ç€';
      document.getElementById('nextAction').textContent = 'ãŠç–²ã‚Œæ§˜ã§ã—ãŸ';
      return;
    }
    
    // æ‰¾åˆ°å½“å‰æœ€æ¥è¿‘çš„æ­¥éª¤
    let closestStepIndex = 0;
    let minDistance = Infinity;
    
    for (let i = 0; i < totalSteps; i++) {
      const step = steps[i];
      const stepStart = step.start_location;
      const stepEnd = step.end_location;
      
      // è®¡ç®—åˆ°æ­¥éª¤èµ·ç‚¹å’Œç»ˆç‚¹çš„è·ç¦»
      const distanceToStart = calculateDistance(currentLocation, {
        lat: stepStart.lat(),
        lng: stepStart.lng()
      });
      const distanceToEnd = calculateDistance(currentLocation, {
        lat: stepEnd.lat(),
        lng: stepEnd.lng()
      });
      
      // é€‰æ‹©è·ç¦»è¾ƒè¿‘çš„æ­¥éª¤
      const stepDistance = Math.min(distanceToStart, distanceToEnd);
      if (stepDistance < minDistance) {
        minDistance = stepDistance;
        closestStepIndex = i;
      }
    }
    
    const currentStep = steps[closestStepIndex];
    const instruction = currentStep.instructions.replace(/<[^>]*>/g, ''); // ç§»é™¤HTMLæ ‡ç­¾
    const distance = currentStep.distance ? currentStep.distance.value : 0;
    
    // è§£ææŒ‡ä»¤ï¼Œæå–è¡—é“åå’ŒåŠ¨ä½œ
    let streetName = 'ç¾åœ¨åœ°';
    let action = instruction;
    
    // å°è¯•æå–è¡—é“å
    const streetMatch = instruction.match(/(.+?)(?:ã«|ã§|ã‚’|ã¸)/);
    if (streetMatch) {
      streetName = streetMatch[1].trim();
    }
    
    // å°è¯•æå–åŠ¨ä½œ
    const actionMatch = instruction.match(/(?:ã«|ã§|ã‚’|ã¸)(.+)/);
    if (actionMatch) {
      action = actionMatch[1].trim();
    }
    
    // æ ¼å¼åŒ–è·ç¦»æ˜¾ç¤º
    let distanceText = '';
    if (distance > 0) {
      if (distance < 1000) {
        distanceText = Math.round(distance) + 'm';
      } else {
        distanceText = (distance / 1000).toFixed(1) + 'km';
      }
    }
    
    // æ›´æ–°æ˜¾ç¤º
    document.getElementById('currentStreet').textContent = streetName;
    document.getElementById('nextAction').textContent = action + (distanceText ? ' (' + distanceText + ')' : '');
    
    // å®æ—¶æ›´æ–°åº•éƒ¨ä¿¡æ¯
    updateBottomInfo();
  }

  // æ›´æ–°åº•éƒ¨ä¿¡æ¯
  function updateBottomInfo() {
    if (!currentRoute || !currentLocation) return;
    
    // è®¡ç®—å½“å‰ä½ç½®åˆ°ç›®çš„åœ°çš„è·ç¦»
    const remainingDistanceMeters = calculateDistance(currentLocation, dest);
    const totalDistanceMeters = currentRoute.legs[0].distance.value;
    
    // è®¡ç®—å‰©ä½™æ—¶é—´ï¼ˆåŸºäºæ­¥è¡Œé€Ÿåº¦ 5km/hï¼‰
    const walkingSpeed = 5000 / 3600; // ç±³/ç§’
    const remainingTimeSeconds = remainingDistanceMeters / walkingSpeed;
    const remainingTimeMinutes = Math.round(remainingTimeSeconds / 60);
    
    // æ›´æ–°å‰©ä½™è·ç¦»
    let distanceText;
    if (remainingDistanceMeters < 1000) {
      distanceText = Math.round(remainingDistanceMeters) + 'm';
    } else {
      distanceText = (remainingDistanceMeters / 1000).toFixed(2) + 'km';
    }
    
    // æ›´æ–°å‰©ä½™æ—¶é—´
    let timeText;
    if (remainingTimeMinutes < 60) {
      timeText = remainingTimeMinutes + 'åˆ†';
    } else {
      const hours = Math.floor(remainingTimeMinutes / 60);
      const minutes = remainingTimeMinutes % 60;
      timeText = hours + 'æ™‚é–“' + (minutes > 0 ? minutes + 'åˆ†' : '');
    }
    
    // è®¡ç®—åˆ°è¾¾æ—¶é—´
    const now = new Date();
    const arrivalTime = new Date(now.getTime() + remainingTimeSeconds * 1000);
    const arrivalTimeText = arrivalTime.toLocaleTimeString('ja-JP', { 
      hour: '2-digit', 
      minute: '2-digit',
      timeZone: 'Asia/Tokyo'
    });
    
    // æ›´æ–°DOM
    document.getElementById('remainingTime').textContent = timeText;
    document.getElementById('remainingDistance').textContent = distanceText;
    document.getElementById('arrivalTime').textContent = arrivalTimeText;
    
    console.log('æ›´æ–°ä¿¡æ¯ - å‰©ä½™è·ç¦»:', distanceText, 'å‰©ä½™æ—¶é—´:', timeText, 'åˆ°è¾¾æ—¶é—´:', arrivalTimeText);
  }
  
  // è·å–åˆ°è¾¾æ—¶é—´
  function getArrivalTime() {
    if (!currentRoute) return '--:--';
    
    const now = new Date();
    const leg = currentRoute.legs[0];
    const durationSeconds = leg.duration ? leg.duration.value : 0;
    const arrival = new Date(now.getTime() + durationSeconds * 1000);
    
    return arrival.toLocaleTimeString('ja-JP', { 
      hour: '2-digit', 
      minute: '2-digit',
      timeZone: 'Asia/Tokyo'
    });
  }

  // å…¨å±€å›è°ƒï¼ˆç”± script çš„ callback=init è§¦å‘ï¼‰
  window.init = init;
</script>
</body>
</html>
